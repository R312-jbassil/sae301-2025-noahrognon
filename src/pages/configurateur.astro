---
import Layout from "../layouts/Layout.astro";
import { handleAuthFromCookies } from "../utils/auth.js";
import {
    CONFIG_BASE_PRICE,
    MAX_GRAVURE_LENGTH,
    svgToString,
    storageKey,
    encodeState,
    decodeState
} from "../utils/configurator.js";
import svgUrl from "../assets/lunettes.svg?url";

export const prerender = false;

const { pb, authCookie } = await handleAuthFromCookies(Astro.request);

if (authCookie) {
    Astro.response.headers.set("Set-Cookie", authCookie);
}

if (!pb.authStore?.isValid || !pb.authStore.model) {
    return Astro.redirect(`/login?redirect=${encodeURIComponent(Astro.url.pathname)}`);
}

const user = pb.authStore.model;
const basePriceLabel = `${CONFIG_BASE_PRICE}&euro;`;
---

<Layout
    title="Configurateur | TaVue"
    bodyClass="bg-[#0E1013] text-[#EDE9DF]"
    mainClass="min-h-screen pb-24"
>
    <section class="mx-auto max-w-6xl px-6 py-12 md:py-16">
        <header class="mb-10 space-y-6">
            <div class="flex flex-wrap items-center justify-between gap-4">
                <div class="flex flex-wrap items-center gap-4 text-xs text-[#929DA8]">
                    <span class="inline-flex items-center gap-2 rounded-full border border-[#1E2328] bg-[#14181D] px-4 py-2">
                        <svg viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.6" class="h-4 w-4 text-[#D1B17A]">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M16.667 3.333H3.333A1.667 1.667 0 0 0 1.667 5v10a1.667 1.667 0 0 0 1.666 1.667h13.334A1.667 1.667 0 0 0 18.334 15V5a1.667 1.667 0 0 0-1.667-1.667z" />
                            <path stroke-linecap="round" stroke-linejoin="round" d="M1.667 8.333h16.667" />
                        </svg>
                        <span>Livraison 7 jours</span>
                    </span>
                    <span class="inline-flex items-center gap-2 rounded-full border border-[#1E2328] bg-[#14181D] px-4 py-2">
                        <svg viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.6" class="h-4 w-4 text-[#D1B17A]">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M10 18.333c4.6 0 8.333-3.733 8.333-8.333S14.6 1.667 10 1.667 1.667 5.4 1.667 10 5.4 18.333 10 18.333z" />
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6.667 10l2.5 2.5 4.167-5" />
                        </svg>
                        <span>Garantie 2 ans</span>
                    </span>
                    <span class="inline-flex items-center gap-2 rounded-full border border-[#1E2328] bg-[#14181D] px-4 py-2">
                        <svg viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.6" class="h-4 w-4 text-[#D1B17A]">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M10 1.667v8.333h6.667" />
                            <path stroke-linecap="round" stroke-linejoin="round" d="M18.333 10a8.333 8.333 0 1 1-8.333-8.333" />
                        </svg>
                        <span>Gravure offerte</span>
                    </span>
                </div>
                <div class="inline-flex items-center gap-2 rounded-full border border-[#1E2328] bg-[#14181D] px-4 py-2 text-xs text-[#929DA8]">
                    <svg viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.6" class="h-4 w-4 text-[#D1B17A]">
                        <circle cx="10" cy="10" r="7.5" />
                        <path stroke-linecap="round" stroke-linejoin="round" d="M10 6.667v4.166l2.5 1.25" />
                    </svg>
                    <span><strong class="text-[#D1B17A]">23 personnes</strong> configurent actuellement</span>
                </div>
            </div>

            <div class="flex flex-wrap items-center justify-between gap-6">
                <div>
                    <p class="text-xs uppercase tracking-[0.4em] text-[#6C7580]">Etape actuelle</p>
                    <h1 class="font-playfair text-3xl text-white md:text-4xl" set:html={'Configurateur de lunettes'}></h1>
                    <p class="mt-2 text-sm text-[#8F9AA5]" set:html={'Cr&eacute;ez votre paire unique en quelques clics'}></p>
                </div>
                <button
                    id="hero-guide"
                    class="inline-flex items-center gap-2 rounded-full border border-[#252A30] bg-[#15191D] px-5 py-3 text-sm font-semibold text-[#EDE9DF] transition hover:border-[#D1B17A]"
                >
                    <svg viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.6" class="h-4 w-4 text-[#D1B17A]">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M10 3.333 3.333 6.667 10 10l6.667-3.333L10 3.333z" />
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3.333 13.333 10 16.667l6.667-3.334" />
                    </svg>
                    Guide
                </button>
            </div>

            <nav id="stepper" class="flex flex-wrap items-center gap-4 text-sm text-[#929DA8]">
                <button data-step="1" class="step-btn inline-flex flex-1 items-center gap-3 rounded-full border border-[#2A2F35] bg-[#15191D] px-5 py-2 transition">
                    <span class="flex h-7 w-7 items-center justify-center rounded-full bg-[#D1B17A] font-semibold text-[#1E1A14]">1</span>
                    <span class="hidden text-left md:block">
                        <strong class="block text-[#EDE9DF]">Mat&eacute;riaux</strong>
                        <span class="text-xs text-[#717B86]">Monture &amp; branches</span>
                    </span>
                </button>
                <div class="hidden h-0.5 flex-1 bg-[#1E2328] md:block"></div>
                <button data-step="2" class="step-btn inline-flex flex-1 items-center gap-3 rounded-full border border-[#2A2F35] bg-[#11151A] px-5 py-2 transition">
                    <span class="flex h-7 w-7 items-center justify-center rounded-full bg-[#1F242A] font-semibold text-[#8F9AA5]">2</span>
                    <span class="hidden text-left md:block">
                        <strong class="block text-[#929DA8]">Style</strong>
                        <span class="text-xs text-[#5E6771]">Verres &amp; finitions</span>
                    </span>
                </button>
                <div class="hidden h-0.5 flex-1 bg-[#1E2328] md:block"></div>
                <button data-step="3" class="step-btn inline-flex flex-1 items-center gap-3 rounded-full border border-[#2A2F35] bg-[#11151A] px-5 py-2 transition">
                    <span class="flex h-7 w-7 items-center justify-center rounded-full bg-[#1F242A] font-semibold text-[#8F9AA5]">3</span>
                    <span class="hidden text-left md:block">
                        <strong class="block text-[#929DA8]">Gravure</strong>
                        <span class="text-xs text-[#5E6771]">Personnalisation</span>
                    </span>
                </button>
                <div class="hidden h-0.5 flex-1 bg-[#1E2328] md:block"></div>
                <div class="inline-flex flex-1 items-center gap-3 rounded-full border border-[#2A2F35] bg-[#0F1216] px-5 py-2 text-[#545C66]">
                    <span class="flex h-7 w-7 items-center justify-center rounded-full bg-[#1A1F24] font-semibold">4</span>
                    <span class="hidden text-left md:block">
                        <strong class="block">Validation</strong>
                        <span class="text-xs">Commander</span>
                    </span>
                </div>
            </nav>
        </header>
        <div class="text-center">
            <h2 class="font-playfair text-5xl text-white">Configurateur de lunettes</h2>
            <p class="mt-4 text-lg text-[#8F9AA5]">Cr&eacute;ez votre paire unique en quelques clics</p>
            <div class="mt-6 flex flex-wrap items-center justify-center gap-6 text-sm">
                <span class="inline-flex items-center gap-2 text-[#EDE9DF]">
                    <svg viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.6" class="h-4 w-4 text-[#D1B17A]">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3.333 5.833 10 10l6.667-4.167" />
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3.333 10l6.667 4.167L16.667 10" />
                    </svg>
                    Livraison 7 jours
                </span>
                <span class="inline-flex items-center gap-2 text-[#EDE9DF]">
                    <svg viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.6" class="h-4 w-4 text-[#D1B17A]">
                        <circle cx="10" cy="10" r="7.5" />
                        <path stroke-linecap="round" stroke-linejoin="round" d="M10 6.667v4.166l2.5 1.25" />
                    </svg>
                    Garantie 2 ans
                </span>
                <span class="inline-flex items-center gap-2 text-[#EDE9DF]">
                    <svg viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.6" class="h-4 w-4 text-[#D1B17A]">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M5.833 3.333 10 10l4.167-6.667" />
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3.333 8.333 10 16.667l6.667-8.334" />
                    </svg>
                    Gravure offerte
                </span>
            </div>
            <div class="mt-6 inline-flex items-center gap-2 rounded-full border border-[#2A2F35] bg-[#15191D] px-4 py-2 text-sm text-[#EDE9DF]">
                <svg viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.6" class="h-4 w-4 text-[#D1B17A]">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M10 1.667 12.5 7.5H18.333L13.667 11.042 15.5 17.5 10 13.958 4.5 17.5 6.333 11.042 1.667 7.5H7.5z" />
                </svg>
                <span><strong class="text-[#D1B17A]">23 personnes</strong> configurent actuellement</span>
            </div>
        </div>

        <div class="mt-12 grid gap-8 lg:grid-cols-[1fr_420px]">
            <div class="space-y-6">
                <div class="flex items-center justify-between rounded-2xl border border-[#1E2328] bg-[#14191D] p-4 shadow-md">
                    <div class="flex items-center gap-2">
                        <button id="btn-undo" class="rounded-full border border-transparent p-2 text-[#EDE9DF] transition hover:border-[#2A2F35] disabled:opacity-30" disabled>
                            <svg viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.6" class="h-4 w-4">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M9 4.5 5 8l4 3.5" />
                                <path stroke-linecap="round" stroke-linejoin="round" d="M5 8h7a3 3 0 0 1 0 6h-1" />
                            </svg>
                        </button>
                        <button id="btn-redo" class="rounded-full border border-transparent p-2 text-[#EDE9DF] transition hover:border-[#2A2F35] disabled:opacity-30" disabled>
                            <svg viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.6" class="h-4 w-4">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M11 4.5 15 8l-4 3.5" />
                                <path stroke-linecap="round" stroke-linejoin="round" d="M15 8h-7a3 3 0 0 0 0 6h1" />
                            </svg>
                        </button>
                        <div class="mx-2 h-6 w-px bg-[#1E2328]"></div>
                        <button id="btn-guide" class="inline-flex items-center gap-2 rounded-full border border-transparent px-3 py-2 text-sm text-[#EDE9DF] transition hover:border-[#2A2F35]">
                            <svg viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.6" class="h-4 w-4">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M9.167 3.333h-3.5A1.667 1.667 0 0 0 4 5v10a1.667 1.667 0 0 0 1.667 1.667h8.666A1.667 1.667 0 0 0 16 15V7.5L11.833 3.333z" />
                                <path stroke-linecap="round" stroke-linejoin="round" d="M9.167 3.333V7.5H16" />
                            </svg>
                            Guide
                        </button>
                    </div>
                    <button id="btn-zoom" class="inline-flex items-center gap-2 rounded-full border border-[#D1B17A] px-3 py-2 text-sm text-[#D1B17A] transition hover:bg-[#D1B17A] hover:text-[#1E1A14]">
                        <svg viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.6" class="h-4 w-4">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12.5 4.167h3.333V7.5" />
                            <path stroke-linecap="round" stroke-linejoin="round" d="M7.5 15.833H4.167V12.5" />
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15.833 4.167 11.25 8.75" />
                            <path stroke-linecap="round" stroke-linejoin="round" d="M4.167 15.833 8.75 11.25" />
                        </svg>
                        Voir en grand
                    </button>
                </div>

                <div class="relative overflow-hidden rounded-[2.5rem] border border-[#D1B17A]/15 bg-gradient-to-br from-[#090A0C] via-[#0D1014] to-[#07080A] p-6 shadow-[0_35px_70px_rgba(0,0,0,0.55)]">
                    <div class="pointer-events-none absolute inset-0 opacity-5">
                        <div class="absolute top-10 right-16 h-40 w-40 rounded-full bg-[#D1B17A] blur-3xl"></div>
                        <div class="absolute bottom-10 left-16 h-32 w-32 rounded-full bg-[#D1B17A] blur-3xl"></div>
                    </div>
                    <div class="absolute left-6 top-6 rounded-full border border-[#D1B17A]/30 bg-[#11161B]/90 px-6 py-3 text-center shadow-lg">
                        <p class="text-xs text-[#8F9AA5]">Prix</p>
                        <p id="price-display" class="font-playfair text-2xl text-[#D1B17A]" set:html={basePriceLabel}></p>
                    </div>
                    <div id="engraving-badge" class="absolute right-6 top-6 hidden items-center gap-2 rounded-full bg-[#D1B17A] px-4 py-2 text-sm font-semibold text-[#1E1A14] shadow-lg">
                        <svg viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.6" class="h-4 w-4">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M4.167 6.667 10 3.333l5.833 3.334" />
                            <path stroke-linecap="round" stroke-linejoin="round" d="M4.167 13.333 10 16.667l5.833-3.334" />
                            <path stroke-linecap="round" stroke-linejoin="round" d="M4.167 10 10 13.333 15.833 10" />
                        </svg>
                        <span id="engraving-label"></span>
                    </div>
                    <div class="relative mx-auto flex h-[520px] max-w-4xl items-center justify-center">
                        <object id="glasses-svg" data={svgUrl.src} type="image/svg+xml" class="h-full w-full"></object>
                    </div>
                </div>
                <div class="rounded-2xl border border-[#1E2328] bg-[#14191D] p-6 shadow-md">
                    <h3 class="font-playfair text-xl text-white">R&eacute;capitulatif de votre configuration</h3>
                    <div class="mt-4 grid gap-4 text-sm text-[#EDE9DF] md:grid-cols-2">
                        <div class="flex justify-between"><span class="text-[#8F9AA5]">Monture</span><span id="summary-frame">Metal</span></div>
                        <div class="flex justify-between"><span class="text-[#8F9AA5]">Branches</span><span id="summary-temple">Metal</span></div>
                        <div class="flex justify-between"><span class="text-[#8F9AA5]">Pont</span><span id="summary-bridge">5 mm</span></div>
                        <div class="flex justify-between"><span class="text-[#8F9AA5]">Verres</span><span id="summary-lens">Taille 5</span></div>
                        <div class="flex justify-between"><span class="text-[#8F9AA5]">Couleur</span><span id="summary-color">Transparent</span></div>
                        <div class="flex justify-between"><span class="text-[#8F9AA5]">Finition</span><span id="summary-finish">Brillant</span></div>
                        <div class="hidden justify-between md:flex"><span class="text-[#8F9AA5]">Gravure</span><span id="summary-engraving">Aucune gravure</span></div>
                    </div>
                    <div class="mt-6 space-y-2">
                        <div class="flex justify-between text-sm text-[#EDE9DF]"><span class="text-[#8F9AA5]">Progression</span><span id="progress-percent" class="text-[#D1B17A]">0%</span></div>
                        <div class="h-2 w-full overflow-hidden rounded-full bg-[#1E2328]"><div id="progress-bar" class="h-full w-0 rounded-full bg-[#D1B17A]"></div></div>
                    </div>
                    <div class="mt-6 flex flex-col gap-3 md:flex-row">
                        <button id="btn-prev-step" class="flex-1 rounded-full border border-[#2A2F35] px-4 py-3 text-sm text-[#EDE9DF] transition hover:border-[#D1B17A]" disabled>
                            <span class="inline-flex items-center gap-2"><span>&larr;</span><span>Etape precedente</span></span>
                        </button>
                        <button id="btn-next-step" class="flex-1 rounded-full bg-[#D1B17A] px-4 py-3 text-sm font-semibold text-[#1E1A14] transition hover:bg-[#D1B17A]/90">
                            <span class="inline-flex items-center gap-2"><span>Etape suivante</span><span>&rarr;</span></span>
                        </button>
                    </div>
                </div>
            </div>

            <aside class="space-y-6 lg:sticky lg:top-40">
                <div class="rounded-3xl border border-[#1A1E23] bg-[#111419] p-6 shadow-[0_25px_55px_rgba(0,0,0,0.45)]">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-xs uppercase tracking-[0.35em] text-[#6E7883]">Assistant IA</p>
                            <p class="mt-1 text-sm text-[#EDE9DF]">Configurez avec notre guide intelligent</p>
                        </div>
                        <button id="btn-open-ai" class="rounded-full border border-[#2D3136] px-3 py-1 text-xs text-[#8C97A2] transition hover:border-[#D1B17A]">Sur mesure</button>
                    </div>
                    <div class="mt-4 flex items-center gap-3">
                        <div class="h-1 flex-1 rounded-full bg-[#1F242A]"><div id="step-progress" class="h-full w-1/5 rounded-full bg-[#D1B17A]"></div></div>
                        <span id="step-label" class="text-xs text-[#8C97A2]">Etape 1 sur 4</span>
                    </div>

                    <div class="mt-6 flex gap-3 text-xs font-semibold text-[#8C97A2]" id="panel-tabs">
                        <button data-panel="materials" class="panel-tab flex-1 rounded-full border border-[#2C3137] bg-[#15191D] px-4 py-2 text-center">Mat&eacute;riaux</button>
                        <button data-panel="style" class="panel-tab flex-1 rounded-full border border-[#1E2328] bg-[#101317] px-4 py-2 text-center">Style</button>
                        <button data-panel="engraving" class="panel-tab flex-1 rounded-full border border-[#1E2328] bg-[#101317] px-4 py-2 text-center">Gravure</button>
                    </div>

                    <section data-panel="materials" class="mt-6 space-y-5">
                        <div>
                            <label for="frame-select" class="text-xs uppercase tracking-[0.28em] text-[#6E7883]">Mat&eacute;riau monture</label>
                            <select id="frame-select" class="mt-2 w-full rounded-2xl border border-[#1E2227] bg-[#16191D] px-4 py-3 text-sm text-[#E5E1D7] focus:border-[#D1B17A] focus:outline-none"></select>
                        </div>
                        <div>
                            <label for="temple-select" class="text-xs uppercase tracking-[0.28em] text-[#6E7883]">Mat&eacute;riau branches</label>
                            <select id="temple-select" class="mt-2 w-full rounded-2xl border border-[#1E2227] bg-[#16191D] px-4 py-3 text-sm text-[#E5E1D7] focus:border-[#D1B17A] focus:outline-none"></select>
                        </div>
                        <div>
                            <label for="bridge-range" class="text-xs uppercase tracking-[0.28em] text-[#6E7883]">Largeur du pont</label>
                            <input id="bridge-range" type="range" min="2" max="8" value="5" step="1" class="mt-3 block h-1 w-full appearance-none rounded-full bg-[#20252B]" />
                            <div class="mt-1 text-xs text-[#8C97A2]"><span id="bridge-value">5</span> mm</div>
                        </div>
                        <div>
                            <label for="lens-range" class="text-xs uppercase tracking-[0.28em] text-[#6E7883]">Taille des verres</label>
                            <input id="lens-range" type="range" min="1" max="9" value="5" step="1" class="mt-3 block h-1 w-full appearance-none rounded-full bg-[#20252B]" />
                            <div class="mt-1 text-xs text-[#8C97A2]">Taille <span id="lens-value">5</span></div>
                        </div>
                    </section>

                    <section data-panel="style" class="mt-6 hidden space-y-5">
                        <div>
                            <p class="text-xs uppercase tracking-[0.28em] text-[#6E7883]">Couleur des verres</p>
                            <div id="lens-swatches" class="mt-3 grid grid-cols-3 gap-3"></div>
                        </div>
                        <div>
                            <p class="text-xs uppercase tracking-[0.28em] text-[#6E7883]">Finition de surface</p>
                            <div id="finish-buttons" class="mt-3 grid grid-cols-3 gap-3">
                                <button data-finish="brillant" class="finish-btn rounded-2xl border border-[#2C3137] bg-[#15191D] px-3 py-3 text-left text-xs text-[#EDE9DF]">
                                    <span class="block text-sm font-semibold">Brillant</span>
                                    <span class="text-[11px] text-[#868F99]">Reflets lumineux</span>
                                </button>
                                <button data-finish="mat" class="finish-btn rounded-2xl border border-[#1E2328] bg-[#101317] px-3 py-3 text-left text-xs text-[#EDE9DF]">
                                    <span class="block text-sm font-semibold">Mat</span>
                                    <span class="text-[11px] text-[#5E6771]">Sobre et elegant</span>
                                </button>
                                <button data-finish="satin" class="finish-btn rounded-2xl border border-[#1E2328] bg-[#101317] px-3 py-3 text-left text-xs text-[#EDE9DF]">
                                    <span class="block text-sm font-semibold">Satine</span>
                                    <span class="text-[11px] text-[#5E6771]">Doux au toucher</span>
                                </button>
                            </div>
                        </div>
                    </section>

                    <section data-panel="engraving" class="mt-6 hidden space-y-5">
                        <div>
                            <label for="engraving-input" class="text-xs uppercase tracking-[0.28em] text-[#6E7883]">Texte de gravure</label>
                            <input id="engraving-input" maxlength={MAX_GRAVURE_LENGTH} placeholder="Ex: Initiales, date..." class="mt-2 w-full rounded-2xl border border-[#1E2227] bg-[#16191D] px-4 py-3 text-sm text-[#E5E1D7] focus:border-[#D1B17A] focus:outline-none" />
                            <p class="mt-2 text-xs text-[#6C7580]">Maximum 20 caracteres - +45&euro;</p>
                        </div>
                        <div class="grid gap-4 md:grid-cols-2">
                            <div>
                                <label for="engraving-position" class="text-xs uppercase tracking-[0.28em] text-[#6E7883]">Position</label>
                                <select id="engraving-position" class="mt-2 w-full rounded-2xl border border-[#1E2227] bg-[#16191D] px-4 py-3 text-sm text-[#E5E1D7] focus:border-[#D1B17A] focus:outline-none">
                                    <option value="branche-droit">Branche droite</option>
                                    <option value="branche-gauche">Branche gauche</option>
                                    <option value="pont">Sur le pont</option>
                                </select>
                            </div>
                            <div>
                                <label for="engraving-style" class="text-xs uppercase tracking-[0.28em] text-[#6E7883]">Style</label>
                                <select id="engraving-style" class="mt-2 w-full rounded-2xl border border-[#1E2227] bg-[#16191D] px-4 py-3 text-sm text-[#E5E1D7] focus:border-[#D1B17A] focus:outline-none">
                                    <option value="script">Script</option>
                                    <option value="serif">Serif</option>
                                    <option value="sans">Sans</option>
                                </select>
                            </div>
                        </div>
                    </section>

                    <div class="mt-6 rounded-2xl border border-[#1E2328] bg-[#15191D] px-4 py-3 text-xs text-[#8C97A2]">
                        <span class="block font-semibold text-[#D1B17A]">Suggestion de combinaison</span>
                        <span>Titane + bois + or rose + ac&eacute;tate + metal + satine</span>
                        <div class="mt-2 inline-flex items-center gap-2 text-[11px] text-[#6E7883]">
                            <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5" class="h-3.5 w-3.5 text-[#D1B17A]">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M8 1.667 9.89 6.5h4.777l-3.866 2.95 1.477 4.883L8 11.551l-4.278 2.782 1.478-4.883L1.334 6.5H6.11z" />
                            </svg>
                            <span>412 paires personnalisees ce mois-ci</span>
                        </div>
                    </div>

                    <div class="mt-6 flex items-center justify-between text-sm text-[#9AA6B0]">
                        <span>Prix final</span>
                        <span id="panel-price" class="text-xl font-semibold text-[#D1B17A]" set:html={basePriceLabel}></span>
                    </div>
                    <div class="mt-4 flex gap-3">
                        <button id="btn-save" class="flex-1 rounded-full border border-[#2D3136] px-4 py-3 text-sm font-semibold text-[#E5E1D7] transition hover:border-[#D1B17A]">Sauvegarder</button>
                        <button id="btn-order" class="flex-1 rounded-full bg-[#D1B17A] px-4 py-3 text-sm font-semibold text-[#1E1A14] transition hover:bg-[#D1B17A]/90">Commander</button>
                    </div>
                </div>
            </aside>
        </div>
        <div class="mt-16 rounded-3xl border border-[#1A1E23] bg-[#111419] p-8 shadow-[0_25px_55px_rgba(0,0,0,0.45)]">
            <div class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
                <div>
                    <h3 class="font-playfair text-3xl text-white">Inspiration du moment</h3>
                    <p class="text-sm text-[#8F9AA5]">Nos configurations les plus populaires cette semaine</p>
                </div>
                <span class="inline-flex items-center gap-2 rounded-full border border-[#D1B17A]/30 bg-[#D1B17A]/10 px-4 py-2 text-xs text-[#D1B17A]">
                    <svg viewBox="0 0 16 16" fill="currentColor" class="h-3.5 w-3.5"><path d="M8 0l1.882 4.854 5.118.43-3.874 3.3 1.2 4.939L8 10.98l-4.326 2.543 1.2-4.939-3.874-3.3 5.118-.43L8 0z" /></svg>
                    Tendances
                </span>
            </div>
            <div class="mt-8 grid gap-6 md:grid-cols-4" id="preset-grid"></div>
        </div>

        <div class="mt-10 grid gap-6 md:grid-cols-3">
            <div class="rounded-2xl border border-[#D1B17A]/20 bg-[#D1B17A]/5 p-6 text-center text-[#EDE9DF]">
                <svg viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.6" class="mx-auto mb-3 h-8 w-8 text-[#D1B17A]">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3.333 5.833 10 10l6.667-4.167" />
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3.333 10l6.667 4.167L16.667 10" />
                </svg>
                <h4 class="font-playfair text-lg">Livraison express</h4>
                <p class="mt-1 text-sm text-[#8F9AA5]">Fabrication et livraison en 7 jours</p>
            </div>
            <div class="rounded-2xl border border-[#D1B17A]/20 bg-[#D1B17A]/5 p-6 text-center text-[#EDE9DF]">
                <svg viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.6" class="mx-auto mb-3 h-8 w-8 text-[#D1B17A]">
                    <circle cx="10" cy="10" r="7.5" />
                    <path stroke-linecap="round" stroke-linejoin="round" d="M10 6.667v4.166l2.5 1.25" />
                </svg>
                <h4 class="font-playfair text-lg">Garantie 2 ans</h4>
                <p class="mt-1 text-sm text-[#8F9AA5]">Protection compl&egrave;te contre les defauts</p>
            </div>
            <div class="rounded-2xl border border-[#D1B17A]/20 bg-[#D1B17A]/5 p-6 text-center text-[#EDE9DF]">
                <svg viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.6" class="mx-auto mb-3 h-8 w-8 text-[#D1B17A]">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M4.167 10H15" />
                    <path stroke-linecap="round" stroke-linejoin="round" d="M7.5 6.667 4.167 10 7.5 13.333" />
                </svg>
                <h4 class="font-playfair text-lg">Retour gratuit</h4>
                <p class="mt-1 text-sm text-[#8F9AA5]">30 jours pour changer d'avis</p>
            </div>
        </div>
    </section>

    <div class="fixed bottom-0 left-0 right-0 z-50 border-t border-[#1A1E23] bg-[#111419] p-4 shadow-2xl lg:hidden">
        <div class="flex items-center justify-between gap-4">
            <div>
                <p class="text-xs text-[#8F9AA5]">Prix total</p>
                <p id="mobile-price" class="font-playfair text-2xl text-[#D1B17A]" set:html={basePriceLabel}></p>
            </div>
            <button id="mobile-order" class="rounded-full bg-[#1E1A14] px-6 py-3 text-sm font-semibold text-[#EDE9DF] transition hover:bg-[#D1B17A] hover:text-[#1E1A14]">Commander</button>
        </div>
    </div>

    <dialog id="zoom-dialog" class="w-full max-w-4xl rounded-[2.5rem] border border-[#1C2126] bg-[#0E1013] p-0 text-[#EDE9DF] shadow-[0_45px_85px_rgba(0,0,0,0.55)]">
        <div class="relative p-12">
            <button id="zoom-close" class="absolute right-4 top-4 rounded-full bg-[#15191D] p-2 text-[#EDE9DF] transition hover:bg-[#D1B17A] hover:text-[#1E1A14]">
                <svg viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.6" class="h-4 w-4">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M5 5l10 10M15 5l-10 10" />
                </svg>
            </button>
            <div class="absolute left-6 top-6 rounded-full border border-[#D1B17A]/30 bg-[#11161B]/90 px-6 py-3 text-center shadow-lg">
                <p class="text-xs text-[#8F9AA5]">Prix</p>
                <p id="zoom-price" class="font-playfair text-2xl text-[#D1B17A]" set:html={basePriceLabel}></p>
            </div>
            <div id="zoom-engraving" class="absolute right-6 top-6 hidden items-center gap-2 rounded-full bg-[#D1B17A] px-4 py-2 text-sm font-semibold text-[#1E1A14] shadow-lg">
                <svg viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.6" class="h-4 w-4"><path stroke-linecap="round" stroke-linejoin="round" d="M4.167 6.667 10 3.333l5.833 3.334" /><path stroke-linecap="round" stroke-linejoin="round" d="M4.167 13.333 10 16.667l5.833-3.334" /><path stroke-linecap="round" stroke-linejoin="round" d="M4.167 10 10 13.333 15.833 10" /></svg>
                <span id="zoom-engraving-label"></span>
            </div>
            <div class="pointer-events-none absolute inset-0 opacity-5">
                <div class="absolute top-16 right-24 h-48 w-48 rounded-full bg-[#D1B17A] blur-3xl"></div>
                <div class="absolute bottom-16 left-24 h-40 w-40 rounded-full bg-[#D1B17A] blur-3xl"></div>
            </div>
            <div class="mx-auto flex max-w-3xl items-center justify-center">
                <object id="zoom-svg" data={svgUrl.src} type="image/svg+xml" class="w-full"></object>
            </div>
            <p class="mt-6 text-center text-sm text-[#8F9AA5]">Vue detaillee de votre creation</p>
        </div>
    </dialog>

    <dialog id="ai-dialog" class="w-full max-w-lg rounded-[2rem] border border-[#1C2126] bg-[#111419] p-0 text-[#EDE9DF] shadow-[0_35px_70px_rgba(0,0,0,0.55)]">
        <form id="ai-form" method="dialog" class="space-y-4 p-6">
            <div class="flex items-center justify-between">
                <h3 class="font-playfair text-2xl">Assistant creatif</h3>
                <button type="button" id="ai-close" class="rounded-full bg-[#15191D] p-2 text-[#EDE9DF] transition hover:bg-[#D1B17A] hover:text-[#1E1A14]">
                    <svg viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.6" class="h-4 w-4">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M5 5l10 10M15 5l-10 10" />
                    </svg>
                </button>
            </div>
            <p class="text-sm text-[#8F9AA5]">Decrivez le style que vous imaginez (ex: "Monture en or rose avec verres miroirs").</p>
            <textarea id="ai-input" rows="4" class="w-full rounded-2xl border border-[#1E2227] bg-[#16191D] px-4 py-3 text-sm text-[#E5E1D7] focus:border-[#D1B17A] focus:outline-none" placeholder="Ex: Lunettes elegantes en titane avec verres verts polaris&eacute;s"></textarea>
            <div class="flex items-center justify-end gap-3">
                <button type="button" id="ai-cancel" class="rounded-full border border-[#2D3136] px-4 py-2 text-sm text-[#EDE9DF] transition hover:border-[#D1B17A]">Annuler</button>
                <button type="submit" class="rounded-full bg-[#D1B17A] px-4 py-2 text-sm font-semibold text-[#1E1A14] transition hover:bg-[#D1B17A]/90">Generer</button>
            </div>
        </form>
    </dialog>

    <dialog id="guide-dialog" class="w-full max-w-2xl rounded-[2rem] border border-[#1C2126] bg-[#111419] p-0 text-[#EDE9DF] shadow-[0_35px_70px_rgba(0,0,0,0.55)]">
        <div class="p-6">
            <div class="flex items-center justify-between">
                <h3 class="font-playfair text-2xl">Conseils de personnalisation</h3>
                <button id="guide-close" class="rounded-full bg-[#15191D] p-2 text-[#EDE9DF] transition hover:bg-[#D1B17A] hover:text-[#1E1A14]">
                    <svg viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.6" class="h-4 w-4"><path stroke-linecap="round" stroke-linejoin="round" d="M5 5l10 10M15 5l-10 10" /></svg>
                </button>
            </div>
            <div class="mt-4 space-y-4 text-sm text-[#B3BDC7]">
                <p><strong class="text-[#D1B17A]">Mat&eacute;riaux</strong> : le metal apporte une touche moderne, le bois une finition naturelle, l'or rose un effet bijou.</p>
                <p><strong class="text-[#D1B17A]">Verres</strong> : optez pour le miroir bleu pour un style audacieux, le vert polarise pour le confort.</p>
                <p><strong class="text-[#D1B17A]">Finition</strong> : brillant pour les reflets, mat pour la sobriete, satine pour une texture douce.</p>
                <p><strong class="text-[#D1B17A]">Gravure</strong> : de 1 &agrave; 20 caracteres, ideal pour des initiales ou une date symbolique.</p>
            </div>
        </div>
    </dialog>

    <div id="config-feedback" class="pointer-events-none fixed bottom-8 right-8 z-40 hidden max-w-xs rounded-2xl border border-[#273038] bg-[#12171B] px-5 py-4 text-sm text-[#E5E1D7] shadow-[0_25px_55px_rgba(0,0,0,0.45)]"></div>
<script type="module">
    const lensColorOptions = {
        "transparent": { label: "Transparent", hex: "#F5EFE6", opacity: 0.18 },
        "gris-fonce": { label: "Gris fonce", hex: "#6F737B", opacity: 0.35 },
        "brun-chaud": { label: "Brun chaud", hex: "#8C6E50", opacity: 0.32 },
        "bleu-miroir": { label: "Bleu miroir", hex: "#7C9BC3", opacity: 0.28 },
        "vert-polarise": { label: "Vert polarise", hex: "#4B8063", opacity: 0.3 },
        "rose-teinte": { label: "Rose teinte", hex: "#C08A95", opacity: 0.34 }
    };

    const finishFilters = {
        brillant: "drop-shadow(0 0 16px rgba(209,177,122,0.28)) saturate(1.08)",
        mat: "saturate(0.65) brightness(0.9)",
        satin: "contrast(1.12) blur(0.35px)"
    };

    const fallbackMaterials = [
        { label: "Metal", slug: "metal", hex: "#DFD8CF", price: 0 },
        { label: "Acetate", slug: "acetate", hex: "#D7C2B5", price: 10 },
        { label: "Bois", slug: "bois", hex: "#C19A6B", price: 80 },
        { label: "Titane", slug: "titane", hex: "#B2B7C5", price: 100 },
        { label: "Or", slug: "or", hex: "#E5C079", price: 250 },
        { label: "Or rose", slug: "rose-gold", hex: "#D8A17E", price: 200 },
        { label: "Ecaille de tortue", slug: "ecaille-tortue", hex: "#A06432", price: 120 }
    ];

    const materialPriceMap = {
        "metal": 0,
        "acetate": 0,
        "bois": 80,
        "titane": 100,
        "or": 250,
        "rose-gold": 200,
        "ecaille-tortue": 120
    };

    const templePriceMap = {
        "metal": 0,
        "acetate": 0,
        "bois": 50,
        "titane": 80,
        "or": 150,
        "rose-gold": 120,
        "ecaille-tortue": 60
    };

    const lensPriceMap = {
        "transparent": 0,
        "gris-fonce": 30,
        "brun-chaud": 30,
        "bleu-miroir": 60,
        "vert-polarise": 60,
        "rose-teinte": 30
    };

    const finishPriceMap = {
        brillant: 50,
        mat: 20,
        satin: 40
    };

    const defaultConfig = {
    frameMaterial: "metal",
    frameHex: fallbackMaterials[0].hex,
    frameMaterialId: null,
    frameLabel: "Metal",
    templeMaterial: "metal",
    templeHex: fallbackMaterials[0].hex,
    templeMaterialId: null,
    templeLabel: "Metal",
        bridgeWidth: 5,
        lensSize: 5,
        lensColor: "transparent",
        finish: "brillant",
        engraving: "",
        engravingPosition: "branche-droit",
        engravingStyle: "script"
    };

    let config = { ...defaultConfig };
    let history = [{ ...config }];
    let historyIndex = 0;
    let currentStep = 1;
    let isSaving = false;
    let autoSaveTimer = null;
    let feedbackTimer = null;

    const lensOrder = Object.keys(lensColorOptions);

    const elements = {
        svg: document.querySelector("#glasses-svg"),
        zoomSvg: document.querySelector("#zoom-svg"),
        priceDisplay: document.querySelector("#price-display"),
        panelPrice: document.querySelector("#panel-price"),
        mobilePrice: document.querySelector("#mobile-price"),
        zoomPrice: document.querySelector("#zoom-price"),
        engravingBadge: document.querySelector("#engraving-badge"),
        engravingLabel: document.querySelector("#engraving-label"),
        zoomEngraving: document.querySelector("#zoom-engraving"),
        zoomEngravingLabel: document.querySelector("#zoom-engraving-label"),
        summaryFrame: document.querySelector("#summary-frame"),
        summaryTemple: document.querySelector("#summary-temple"),
        summaryBridge: document.querySelector("#summary-bridge"),
        summaryLens: document.querySelector("#summary-lens"),
        summaryColor: document.querySelector("#summary-color"),
        summaryFinish: document.querySelector("#summary-finish"),
        summaryEngraving: document.querySelector("#summary-engraving"),
        progressBar: document.querySelector("#progress-bar"),
        progressPercent: document.querySelector("#progress-percent"),
        stepLabel: document.querySelector("#step-label"),
        stepProgress: document.querySelector("#step-progress"),
        panelTabs: document.querySelectorAll("#panel-tabs .panel-tab"),
        panelSections: document.querySelectorAll('[data-panel]'),
        stepButtons: document.querySelectorAll(".step-btn"),
        undoBtn: document.querySelector("#btn-undo"),
        redoBtn: document.querySelector("#btn-redo"),
        saveBtn: document.querySelector("#btn-save"),
        orderBtn: document.querySelector("#btn-order"),
        mobileOrderBtn: document.querySelector("#mobile-order"),
        nextStepBtn: document.querySelector("#btn-next-step"),
        prevStepBtn: document.querySelector("#btn-prev-step"),
        frameSelect: document.querySelector("#frame-select"),
        templeSelect: document.querySelector("#temple-select"),
        bridgeRange: document.querySelector("#bridge-range"),
        bridgeValue: document.querySelector("#bridge-value"),
        lensRange: document.querySelector("#lens-range"),
        lensValue: document.querySelector("#lens-value"),
        lensSwatches: document.querySelector("#lens-swatches"),
        finishButtons: document.querySelectorAll("#finish-buttons .finish-btn"),
        engravingInput: document.querySelector("#engraving-input"),
        engravingPosition: document.querySelector("#engraving-position"),
        engravingStyle: document.querySelector("#engraving-style"),
        presetGrid: document.querySelector("#preset-grid"),
        zoomDialog: document.querySelector("#zoom-dialog"),
        zoomClose: document.querySelector("#zoom-close"),
        zoomButton: document.querySelector("#btn-zoom"),
        aiDialog: document.querySelector("#ai-dialog"),
        aiForm: document.querySelector("#ai-form"),
        aiInput: document.querySelector("#ai-input"),
        aiOpen: document.querySelector("#btn-open-ai"),
        aiClose: document.querySelector("#ai-close"),
        aiCancel: document.querySelector("#ai-cancel"),
        guideDialog: document.querySelector("#guide-dialog"),
        guideOpen: document.querySelector("#hero-guide"),
        guideClose: document.querySelector("#guide-close"),
        guideButton: document.querySelector("#btn-guide"),
        feedback: document.querySelector("#config-feedback")
    };

    const engravingPositions = {
        "pont": { x: 320, y: 206, anchor: "middle", rotate: 0 },
        "branche-droit": { x: 485, y: 168, anchor: "middle", rotate: 7 },
        "branche-gauche": { x: 155, y: 168, anchor: "middle", rotate: -7 }
    };

    function showFeedback(message, type = "info") {
        if (!elements.feedback) return;
        elements.feedback.textContent = message;
        elements.feedback.classList.remove("hidden");
        elements.feedback.classList.remove("border-[#273038]", "border-[#3F2D2D]");
        elements.feedback.classList.add(type === "error" ? "border-[#3F2D2D]" : "border-[#273038]");
        if (feedbackTimer) clearTimeout(feedbackTimer);
        feedbackTimer = setTimeout(() => {
            elements.feedback.classList.add("hidden");
        }, 3200);
    }

    function slugify(label) {
        return label
            .toLowerCase()
            .replace(/[^a-z0-9]+/g, "-")
            .replace(/^-+|-+$/g, "");
    }

    function updateHistory() {
        history = history.slice(0, historyIndex + 1);
        history.push({ ...config });
        historyIndex = history.length - 1;
        elements.undoBtn.disabled = historyIndex === 0;
        elements.redoBtn.disabled = historyIndex === history.length - 1;
    }

    function updateConfig(updates) {
        config = { ...config, ...updates };
        updateHistory();
        render();
        queueAutoSave();
    }

    function undo() {
        if (historyIndex === 0) return;
        historyIndex -= 1;
        config = { ...history[historyIndex] };
        elements.undoBtn.disabled = historyIndex === 0;
        elements.redoBtn.disabled = false;
        render();
        showFeedback("Action annulee");
    }

    function redo() {
        if (historyIndex >= history.length - 1) return;
        historyIndex += 1;
        config = { ...history[historyIndex] };
        elements.redoBtn.disabled = historyIndex === history.length - 1;
        elements.undoBtn.disabled = false;
        render();
        showFeedback("Action retablie");
    }

    function computeTotalPrice() {
        let total = CONFIG_BASE_PRICE;
        total += materialPriceMap[config.frameMaterial] || 0;
        total += templePriceMap[config.templeMaterial] || 0;
        total += lensPriceMap[config.lensColor] || 0;
        total += finishPriceMap[config.finish] || 0;
        if (config.engraving) total += 45;
        return total;
    }

    function completionPercentage() {
        let score = 0;
        if (config.frameMaterial !== "metal") score += 15;
        if (config.templeMaterial !== "metal") score += 15;
        if (config.bridgeWidth !== 5) score += 10;
        if (config.lensSize !== 5) score += 10;
        if (config.lensColor !== "transparent") score += 20;
        if (config.finish !== "brillant") score += 10;
        if (config.engraving) score += 20;
        return Math.min(100, score);
    }

    function updateProgress() {
        const percent = completionPercentage();
        elements.progressBar.style.width = `${percent}%`;
        elements.progressPercent.textContent = `${Math.round(percent)}%`;
    }

    function updateStepIndicators() {
        elements.stepButtons.forEach((btn) => {
            const step = Number(btn.dataset.step);
            const active = currentStep >= step;
            btn.classList.toggle("bg-[#15191D]", active);
            btn.classList.toggle("bg-[#11151A]", !active);
            const badge = btn.querySelector("span");
            if (badge) {
                badge.classList.toggle("bg-[#D1B17A]", currentStep >= step);
                badge.classList.toggle("text-[#1E1A14]", currentStep >= step);
                badge.classList.toggle("bg-[#1F242A]", currentStep < step);
                badge.classList.toggle("text-[#8F9AA5]", currentStep < step);
            }
        });
        elements.stepLabel.textContent = `Etape ${currentStep} sur 4`;
        elements.stepProgress.style.width = `${(currentStep / 4) * 100}%`;
        elements.prevStepBtn.disabled = currentStep === 1;
        elements.nextStepBtn.textContent = currentStep === 4 ? "Commander" : "Etape suivante";
    }

    function setActivePanel(name) {
        elements.panelSections.forEach((section) => {
            section.classList.toggle("hidden", section.dataset.panel !== name);
        });
        elements.panelTabs.forEach((tab) => {
            const active = tab.dataset.panel === name;
            tab.classList.toggle("border-[#2C3137]", active);
            tab.classList.toggle("bg-[#15191D]", active);
            tab.classList.toggle("border-[#1E2328]", !active);
            tab.classList.toggle("bg-[#101317]", !active);
        });
    }

    function updateLensSwatches() {
        elements.lensSwatches.innerHTML = "";
        lensOrder.forEach((key) => {
            const option = lensColorOptions[key];
            const button = document.createElement("button");
            button.type = "button";
            button.dataset.color = key;
            button.className = "lens-btn rounded-2xl border border-[#1E2328] bg-[#101317] px-3 py-3 text-left text-xs text-[#EDE9DF] transition hover:border-[#2C3137]";
            button.innerHTML = `
                <span class="block h-8 w-full rounded-xl" style="background:${option.hex};opacity:${option.opacity};"></span>
                <span class="mt-2 block text-xs font-semibold">${option.label}</span>
            `;
            if (config.lensColor === key) {
                button.classList.add("border-[#D1B17A]");
            }
            button.addEventListener("click", () => updateConfig({ lensColor: key }));
            elements.lensSwatches.appendChild(button);
        });
    }

    function renderFinishButtons() {
        elements.finishButtons.forEach((btn) => {
            const active = btn.dataset.finish === config.finish;
            btn.classList.toggle("border-[#D1B17A]", active);
            btn.classList.toggle("bg-[#15191D]", active);
            btn.classList.toggle("border-[#1E2328]", !active);
            btn.classList.toggle("bg-[#101317]", !active);
        });
    }

    function updateSummary() {
        elements.summaryFrame.textContent = (config.frameLabel || config.frameMaterial).replace(/-/g, " ");
        elements.summaryTemple.textContent = (config.templeLabel || config.templeMaterial).replace(/-/g, " ");
        elements.summaryBridge.textContent = `${config.bridgeWidth} mm`;
        elements.summaryLens.textContent = `Taille ${config.lensSize}`;
        elements.summaryColor.textContent = lensColorOptions[config.lensColor].label;
        elements.summaryFinish.textContent = config.finish;
        elements.summaryEngraving.textContent = config.engraving ? `"${config.engraving}" (${config.engravingStyle})` : "Aucune gravure";
    }

    function applyPriceDisplay(price) {
        const formatted = `${price.toFixed(0)}&euro;`;
        elements.priceDisplay.innerHTML = formatted;
        elements.panelPrice.innerHTML = formatted;
        elements.mobilePrice.innerHTML = formatted;
        elements.zoomPrice.innerHTML = formatted;
    }

    function renderEngravingBadges() {
        if (config.engraving) {
            elements.engravingBadge.classList.remove("hidden");
            elements.engravingLabel.textContent = config.engraving;
            elements.zoomEngraving.classList.remove("hidden");
            elements.zoomEngravingLabel.textContent = config.engraving;
        } else {
            elements.engravingBadge.classList.add("hidden");
            elements.zoomEngraving.classList.add("hidden");
        }
    }

    const svgContexts = [];

    function registerSvg(svgDocument) {
        if (!svgDocument) return;
        const paths = Array.from(svgDocument.querySelectorAll("path"));
        if (paths.length < 6) return;
        const overlay = svgDocument.createElementNS(svgDocument.documentElement.namespaceURI, "g");
        overlay.setAttribute("id", "config-layer");
        svgDocument.documentElement.appendChild(overlay);

        const lensLeft = svgDocument.createElementNS(svgDocument.documentElement.namespaceURI, "ellipse");
        lensLeft.setAttribute("cx", "240");
        lensLeft.setAttribute("cy", "160");
        lensLeft.setAttribute("rx", "58");
        lensLeft.setAttribute("ry", "44");
        const lensRight = svgDocument.createElementNS(svgDocument.documentElement.namespaceURI, "ellipse");
        lensRight.setAttribute("cx", "400");
        lensRight.setAttribute("cy", "160");
        lensRight.setAttribute("rx", "58");
        lensRight.setAttribute("ry", "44");
        const bridge = svgDocument.createElementNS(svgDocument.documentElement.namespaceURI, "rect");
        bridge.setAttribute("x", "304");
        bridge.setAttribute("y", "132");
        bridge.setAttribute("width", "32");
        bridge.setAttribute("height", "56");
        bridge.setAttribute("rx", "14");
        bridge.setAttribute("ry", "14");
        const engraving = svgDocument.createElementNS(svgDocument.documentElement.namespaceURI, "text");
        engraving.setAttribute("fill", "#D1B17A");
        engraving.setAttribute("font-size", "18");
        engraving.setAttribute("font-family", "Georgia, serif");
        engraving.setAttribute("text-anchor", "middle");
        engraving.setAttribute("opacity", "0");

        overlay.appendChild(lensLeft);
        overlay.appendChild(lensRight);
        overlay.appendChild(bridge);
        overlay.appendChild(engraving);

        svgContexts.push({
            doc: svgDocument,
            leftBranch: paths[0],
            leftShade: paths[1],
            rightBranch: paths[2],
            rightShadeA: paths[3],
            rightShadeB: paths[4],
            frame: paths[5],
            overlays: { lensLeft, lensRight, bridge, engraving }
        });

        renderSvg();
    }

    function renderSvg() {
        svgContexts.forEach((ctx) => {
            if (!ctx) return;
            const branchColor = config.templeHex;
            const frameColor = config.frameHex;
            const shadeLight = adjustShade(branchColor, 18);
            const shadeDark = adjustShade(branchColor, -25);

            if (ctx.leftBranch) ctx.leftBranch.setAttribute("fill", frameColor);
            if (ctx.rightBranch) ctx.rightBranch.setAttribute("fill", branchColor);
            if (ctx.leftShade) ctx.leftShade.setAttribute("fill", shadeDark);
            if (ctx.rightShadeA) ctx.rightShadeA.setAttribute("fill", shadeLight);
            if (ctx.rightShadeB) ctx.rightShadeB.setAttribute("fill", shadeDark);
            if (ctx.frame) ctx.frame.setAttribute("fill", frameColor);

            const lensOption = lensColorOptions[config.lensColor];
            ctx.overlays.lensLeft.setAttribute("fill", lensOption.hex);
            ctx.overlays.lensLeft.setAttribute("fill-opacity", lensOption.opacity);
            ctx.overlays.lensRight.setAttribute("fill", lensOption.hex);
            ctx.overlays.lensRight.setAttribute("fill-opacity", lensOption.opacity);

            const bridgeBase = 32;
            const width = bridgeBase + (config.bridgeWidth - 5) * 4;
            const x = 320 - width / 2;
            ctx.overlays.bridge.setAttribute("width", width.toFixed(2));
            ctx.overlays.bridge.setAttribute("x", x.toFixed(2));
            ctx.overlays.bridge.setAttribute("fill", frameColor);

            const scale = 1 + (config.lensSize - 5) * 0.07;
            const rx = (58 * scale).toFixed(2);
            const ry = (44 * scale).toFixed(2);
            ctx.overlays.lensLeft.setAttribute("rx", rx);
            ctx.overlays.lensLeft.setAttribute("ry", ry);
            ctx.overlays.lensRight.setAttribute("rx", rx);
            ctx.overlays.lensRight.setAttribute("ry", ry);

            if (config.engraving) {
                const position = engravingPositions[config.engravingPosition] || engravingPositions["branche-droit"];
                ctx.overlays.engraving.setAttribute("x", String(position.x));
                ctx.overlays.engraving.setAttribute("y", String(position.y));
                ctx.overlays.engraving.setAttribute("text-anchor", position.anchor);
                ctx.overlays.engraving.setAttribute("opacity", "1");
                if (position.rotate) {
                    ctx.overlays.engraving.setAttribute("transform", `rotate(${position.rotate}, ${position.x}, ${position.y})`);
                } else {
                    ctx.overlays.engraving.removeAttribute("transform");
                }
                ctx.overlays.engraving.textContent = config.engraving;
            } else {
                ctx.overlays.engraving.setAttribute("opacity", "0");
                ctx.overlays.engraving.textContent = "";
            }

            ctx.doc.documentElement.style.filter = finishFilters[config.finish] || "";
        });
    }

    function adjustShade(hex, amount) {
        const clean = hex.replace("#", "");
        const num = parseInt(clean, 16);
        let r = (num >> 16) + amount;
        let g = ((num >> 8) & 0xff) + amount;
        let b = (num & 0xff) + amount;
        r = Math.max(0, Math.min(255, r));
        g = Math.max(0, Math.min(255, g));
        b = Math.max(0, Math.min(255, b));
        return `#${((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1)}`;
    }

    function render() {
        const price = computeTotalPrice();
        applyPriceDisplay(price);
        updateProgress();
        updateStepIndicators();
        renderFinishButtons();
        updateSummary();
        renderEngravingBadges();
        elements.bridgeRange.value = String(config.bridgeWidth);
        elements.bridgeValue.textContent = String(config.bridgeWidth);
        elements.lensRange.value = String(config.lensSize);
        elements.lensValue.textContent = String(config.lensSize);
        elements.engravingInput.value = config.engraving;
        elements.engravingPosition.value = config.engravingPosition;
        elements.engravingStyle.value = config.engravingStyle;
        updateSelectValue(elements.frameSelect, config.frameMaterial);
        updateSelectValue(elements.templeSelect, config.templeMaterial);
        updateLensSwatches();
        renderSvg();
        saveLocalState();
    }

    function updateSelectValue(select, slug) {
        Array.from(select.options).forEach((option) => {
            option.selected = option.dataset.slug === slug;
        });
    }

    async function loadMaterials() {
        let materials = [];
        try {
            const response = await fetch("/api/materiaux");
            if (response.ok) {
                materials = await response.json();
            }
        } catch (error) {
            console.error("Materiaux load error", error);
        }
        if (!materials || materials.length === 0) {
            materials = fallbackMaterials;
        } else {
            materials = materials.map((item) => {
                const slug = item.slug || slugify(item.libelle);
                return {
                    label: item.libelle,
                    slug,
                    hex: item.hex || "#DFD8CF",
                    price: Number(item.coef_prix || materialPriceMap[slug] || 0),
                    id: item.id
                };
            });
        }
        populateMaterialSelect(elements.frameSelect, materials, true);
        populateMaterialSelect(elements.templeSelect, materials, false);
    }

    function populateMaterialSelect(select, list, isFrame) {
        select.innerHTML = "";
        list.forEach((material) => {
            if (isFrame) {
                materialPriceMap[material.slug] = material.price ?? 0;
            } else {
                templePriceMap[material.slug] = material.price ?? 0;
            }
            const option = document.createElement("option");
            option.textContent = material.label;
            option.dataset.slug = material.slug;
            option.dataset.hex = material.hex;
            option.dataset.id = material.id || "";
            option.value = material.slug;
            select.appendChild(option);
        });
        const current = isFrame ? config.frameMaterial : config.templeMaterial;
        updateSelectValue(select, current);
        const selected = Array.from(select.options).find((option) => option.dataset.slug === current);
        if (selected) {
            if (isFrame) {
                config.frameHex = selected.dataset.hex;
                config.frameMaterialId = selected.dataset.id || null;
                config.frameLabel = selected.textContent || current;
            } else {
                config.templeHex = selected.dataset.hex;
                config.templeMaterialId = selected.dataset.id || null;
                config.templeLabel = selected.textContent || current;
            }
        }
    }

    const presetData = [
        {
            name: "L' Elegant",
            frame: "or",
            frameHex: fallbackMaterials.find((m) => m.slug === "or").hex,
            temple: "acetate",
            templeHex: fallbackMaterials.find((m) => m.slug === "acetate").hex,
            bridge: 3,
            lens: 6,
            lensColor: "transparent",
            finish: "brillant",
            likes: 342
        },
        {
            name: "Le Naturel",
            frame: "bois",
            frameHex: fallbackMaterials.find((m) => m.slug === "bois").hex,
            temple: "bois",
            templeHex: fallbackMaterials.find((m) => m.slug === "bois").hex,
            bridge: 4,
            lens: 7,
            lensColor: "brun-chaud",
            finish: "mat",
            likes: 289
        },
        {
            name: "Le Moderne",
            frame: "titane",
            frameHex: fallbackMaterials.find((m) => m.slug === "titane").hex,
            temple: "metal",
            templeHex: fallbackMaterials.find((m) => m.slug === "metal").hex,
            bridge: 5,
            lens: 5,
            lensColor: "bleu-miroir",
            finish: "satin",
            likes: 431
        },
        {
            name: "Le Parisien",
            frame: "ecaille-tortue",
            frameHex: fallbackMaterials.find((m) => m.slug === "ecaille-tortue").hex,
            temple: "or",
            templeHex: fallbackMaterials.find((m) => m.slug === "or").hex,
            bridge: 4,
            lens: 6,
            lensColor: "vert-polarise",
            finish: "brillant",
            likes: 518
        }
    ];

    function renderPresets() {
        elements.presetGrid.innerHTML = "";
        presetData.forEach((preset) => {
            const card = document.createElement("button");
            card.type = "button";
            card.className = "preset-card relative overflow-hidden rounded-2xl border border-transparent bg-[#1A1E23] p-6 text-left text-[#EDE9DF] transition hover:border-[#D1B17A] hover:shadow-xl";
            card.innerHTML = `
                <div class="absolute inset-0 bg-gradient-to-br from-[#D1B17A]\/0 to-[#D1B17A]\/0 transition-all duration-300 card-overlay"></div>
                <div class="relative">
                    <div class="mb-4 flex h-32 items-center justify-center rounded-xl bg-[#14191D] p-4">
                        <object data="${svgUrl.src}" type="image/svg+xml" class="h-full w-full preset-svg"></object>
                    </div>
                    <h4 class="font-playfair text-lg">${preset.name}</h4>
                    <div class="mt-2 flex items-center justify-between text-xs text-[#8F9AA5]">
                        <span>Essayer ce style</span>
                        <span class="inline-flex items-center gap-1"><svg viewBox="0 0 16 16" fill="currentColor" class="h-3 w-3 text-[#D1B17A]"><path d="M8 0l1.882 4.854 5.118.43-3.874 3.3 1.2 4.939L8 10.98l-4.326 2.543 1.2-4.939-3.874-3.3 5.118-.43L8 0z" /></svg>${preset.likes}</span>
                    </div>
                </div>
            `;
            card.addEventListener("click", () => {
                const frameOption = Array.from(elements.frameSelect.options).find((option) => option.dataset.slug === preset.frame);
                const templeOption = Array.from(elements.templeSelect.options).find((option) => option.dataset.slug === preset.temple);
                const fallbackFrame = fallbackMaterials.find((material) => material.slug === preset.frame);
                const fallbackTemple = fallbackMaterials.find((material) => material.slug === preset.temple);
                updateConfig({
                    frameMaterial: preset.frame,
                    frameHex: frameOption ? frameOption.dataset.hex : preset.frameHex || (fallbackFrame ? fallbackFrame.hex : config.frameHex),
                    frameMaterialId: frameOption ? frameOption.dataset.id || null : null,
                    frameLabel: frameOption ? frameOption.textContent || preset.frame : (fallbackFrame ? fallbackFrame.label : preset.frame),
                    templeMaterial: preset.temple,
                    templeHex: templeOption ? templeOption.dataset.hex : preset.templeHex || (fallbackTemple ? fallbackTemple.hex : config.templeHex),
                    templeMaterialId: templeOption ? templeOption.dataset.id || null : null,
                    templeLabel: templeOption ? templeOption.textContent || preset.temple : (fallbackTemple ? fallbackTemple.label : preset.temple),
                    bridgeWidth: preset.bridge,
                    lensSize: preset.lens,
                    lensColor: preset.lensColor,
                    finish: preset.finish
                });
                showFeedback(`Style "${preset.name}" applique`);
            });
            elements.presetGrid.appendChild(card);
        });
    }

    function queueAutoSave() {
        if (autoSaveTimer) clearTimeout(autoSaveTimer);
        autoSaveTimer = setTimeout(() => {
            persist(false, true);
        }, 3000);
    }

    function applyAI(prompt) {
        const lower = prompt.toLowerCase();
        const updates = {};
        if (lower.includes("or rose")) {
            updates.frameMaterial = "rose-gold";
        } else if (lower.includes("or")) {
            updates.frameMaterial = "or";
        } else if (lower.includes("titane")) {
            updates.frameMaterial = "titane";
        } else if (lower.includes("bois")) {
            updates.frameMaterial = "bois";
            updates.templeMaterial = "bois";
        }
        if (lower.includes("miroir")) {
            updates.lensColor = "bleu-miroir";
        } else if (lower.includes("polarise")) {
            updates.lensColor = "vert-polarise";
        } else if (lower.includes("fonce") || lower.includes("sombre")) {
            updates.lensColor = "gris-fonce";
        }
        if (lower.includes("grand")) {
            updates.lensSize = 8;
        } else if (lower.includes("petit")) {
            updates.lensSize = 3;
        }
        if (lower.includes("mat")) {
            updates.finish = "mat";
        } else if (lower.includes("satine")) {
            updates.finish = "satin";
        } else if (lower.includes("brillant")) {
            updates.finish = "brillant";
        }
        if (Object.keys(updates).length === 0) {
            showFeedback("Aucune suggestion trouvee", "error");
            return;
        }
        if (updates.frameMaterial) {
            const frameOption = Array.from(elements.frameSelect.options).find((option) => option.dataset.slug === updates.frameMaterial);
            if (frameOption) {
                updates.frameHex = frameOption.dataset.hex;
                updates.frameMaterialId = frameOption.dataset.id || null;
                updates.frameLabel = frameOption.textContent || updates.frameMaterial;
            } else {
                const fallback = fallbackMaterials.find((m) => m.slug === updates.frameMaterial);
                if (fallback) {
                    updates.frameHex = fallback.hex;
                    updates.frameLabel = fallback.label;
                } else {
                    updates.frameHex = config.frameHex;
                    updates.frameLabel = updates.frameMaterial;
                }
                updates.frameMaterialId = null;
            }
        }
        if (updates.templeMaterial) {
            const templeOption = Array.from(elements.templeSelect.options).find((option) => option.dataset.slug === updates.templeMaterial);
            if (templeOption) {
                updates.templeHex = templeOption.dataset.hex;
                updates.templeMaterialId = templeOption.dataset.id || null;
                updates.templeLabel = templeOption.textContent || updates.templeMaterial;
            } else {
                const fallback = fallbackMaterials.find((m) => m.slug === updates.templeMaterial);
                if (fallback) {
                    updates.templeHex = fallback.hex;
                    updates.templeLabel = fallback.label;
                } else {
                    updates.templeHex = config.templeHex;
                    updates.templeLabel = updates.templeMaterial;
                }
                updates.templeMaterialId = null;
            }
        }
        updateConfig(updates);
        showFeedback("Configuration generee par l'assistant");
    }

    async function persist(orderNow = false, isAuto = false) {
        if (isSaving) return;
        if (svgContexts.length === 0) return;
        isSaving = true;
        if (!isAuto) elements.saveBtn.classList.add("opacity-70", "cursor-not-allowed");
        if (orderNow) elements.orderBtn.classList.add("opacity-70", "cursor-not-allowed");
        try {
            const payload = {
                code_svg: svgToString(svgContexts[0].doc),
                largeur_pont: config.bridgeWidth,
                taille_verre: config.lensSize,
                couleur_verre: config.lensColor,
                finition: config.finish,
                gravure: config.engraving,
                position_gravure: config.engravingPosition,
                style_gravure: config.engravingStyle,
                Materiaux_monture: config.frameMaterialId,
                Materiaux_branche: config.templeMaterialId,
                frameSlug: config.frameMaterial,
                frameLabel: config.frameLabel,
                templeSlug: config.templeMaterial,
                templeLabel: config.templeLabel,
                lunetteId: config.lunetteId || null,
                prix_final: computeTotalPrice(),
                orderNow,
                userId: ${JSON.stringify(user.id)}
            };
            const response = await fetch("/api/save-svg", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });
            const result = await response.json().catch(() => ({}));
            if (!response.ok || !result.ok) {
                throw new Error(result.error || "Echec sauvegarde");
            }
            config.lunetteId = result.lunetteId || config.lunetteId;
            if (!isAuto) showFeedback("Configuration sauvegardee");
            if (orderNow && result.commandeId) {
                window.location.href = `/commande/${result.commandeId}`;
            } else if (orderNow) {
                window.location.href = "/login?redirect=/configurateur";
            }
        } catch (error) {
            console.error("Persist error", error);
            if (!isAuto) showFeedback("Impossible de sauvegarder", "error");
        } finally {
            isSaving = false;
            elements.saveBtn.classList.remove("opacity-70", "cursor-not-allowed");
            elements.orderBtn.classList.remove("opacity-70", "cursor-not-allowed");
        }
    }

    function saveLocalState() {
        try {
            localStorage.setItem(storageKey, encodeState(config));
        } catch (error) {
            console.warn("Impossible de sauvegarder l'etat local", error);
        }
    }

    function loadLocalState() {
        try {
            const stored = decodeState(localStorage.getItem(storageKey));
            if (stored) {
                config = { ...config, ...stored };
            }
        } catch (error) {
            console.warn("Impossible de charger l'etat local", error);
        }
        history = [{ ...config }];
        historyIndex = 0;
        elements.undoBtn.disabled = true;
        elements.redoBtn.disabled = true;
    }

    function initEvents() {
        elements.undoBtn.addEventListener("click", undo);
        elements.redoBtn.addEventListener("click", redo);
        elements.saveBtn.addEventListener("click", () => persist(false, false));
        elements.orderBtn.addEventListener("click", () => persist(true, false));
        elements.mobileOrderBtn.addEventListener("click", () => persist(true, false));
        elements.nextStepBtn.addEventListener("click", () => {
            if (currentStep === 4) {
                persist(true, false);
            } else {
                currentStep = Math.min(4, currentStep + 1);
                if (currentStep === 2) setActivePanel("style");
                if (currentStep === 3) setActivePanel("engraving");
                updateStepIndicators();
            }
        });
        elements.prevStepBtn.addEventListener("click", () => {
            currentStep = Math.max(1, currentStep - 1);
            if (currentStep === 1) setActivePanel("materials");
            if (currentStep === 2) setActivePanel("style");
            updateStepIndicators();
        });
        elements.panelTabs.forEach((tab) => {
            tab.addEventListener("click", () => setActivePanel(tab.dataset.panel));
        });
        elements.stepButtons.forEach((btn) => {
            btn.addEventListener("click", () => {
                const step = Number(btn.dataset.step);
                currentStep = step;
                if (step === 1) setActivePanel("materials");
                if (step === 2) setActivePanel("style");
                if (step === 3) setActivePanel("engraving");
                updateStepIndicators();
            });
        });
        elements.frameSelect.addEventListener("change", (event) => {
            const option = event.target.selectedOptions[0];
            updateConfig({
                frameMaterial: option.dataset.slug,
                frameHex: option.dataset.hex,
                frameMaterialId: option.dataset.id || null,
                frameLabel: option.textContent || option.dataset.slug
            });
        });
        elements.templeSelect.addEventListener("change", (event) => {
            const option = event.target.selectedOptions[0];
            updateConfig({
                templeMaterial: option.dataset.slug,
                templeHex: option.dataset.hex,
                templeMaterialId: option.dataset.id || null,
                templeLabel: option.textContent || option.dataset.slug
            });
        });
        elements.bridgeRange.addEventListener("input", (event) => {
            updateConfig({ bridgeWidth: Number(event.target.value) });
        });
        elements.lensRange.addEventListener("input", (event) => {
            updateConfig({ lensSize: Number(event.target.value) });
        });
        elements.finishButtons.forEach((btn) => {
            btn.addEventListener("click", () => {
                updateConfig({ finish: btn.dataset.finish });
            });
        });
        elements.engravingInput.addEventListener("input", (event) => {
            const clean = event.target.value.replace(/[^A-Za-z0-9 .,'-]/g, "");
            if (clean !== event.target.value) event.target.value = clean;
            updateConfig({ engraving: clean });
        });
        elements.engravingPosition.addEventListener("change", (event) => updateConfig({ engravingPosition: event.target.value }));
        elements.engravingStyle.addEventListener("change", (event) => updateConfig({ engravingStyle: event.target.value }));
        elements.zoomButton.addEventListener("click", () => {
            if (typeof elements.zoomDialog.showModal === "function") {
                elements.zoomDialog.showModal();
            }
        });
        elements.zoomClose.addEventListener("click", () => elements.zoomDialog.close());
        elements.aiOpen.addEventListener("click", () => {
            if (typeof elements.aiDialog.showModal === "function") elements.aiDialog.showModal();
        });
        [elements.aiClose, elements.aiCancel].forEach((btn) => {
            btn.addEventListener("click", () => elements.aiDialog.close());
        });
        elements.aiForm.addEventListener("submit", (event) => {
            event.preventDefault();
            const value = elements.aiInput.value.trim();
            if (value) {
                applyAI(value);
            }
            elements.aiInput.value = "";
            elements.aiDialog.close();
        });
        [elements.guideOpen, elements.guideButton].forEach((btn) => {
            if (!btn) return;
            btn.addEventListener("click", () => {
                if (typeof elements.guideDialog.showModal === "function") elements.guideDialog.showModal();
            });
        });
        elements.guideClose.addEventListener("click", () => elements.guideDialog.close());
    }

    function initPresetsSvg() {
        const presetSvgs = document.querySelectorAll(".preset-svg");
        presetSvgs.forEach((obj) => {
            obj.addEventListener("load", () => {
                const doc = obj.contentDocument;
                if (!doc) return;
                const firstPreset = presetData[0];
                const paths = Array.from(doc.querySelectorAll("path"));
                if (paths.length >= 6) {
                    paths[0].setAttribute("fill", firstPreset.frameHex);
                }
            });
        });
    }

    function initialiseSvgObservers() {
        const attach = (object) => {
            if (!object) return;
            if (object.contentDocument) {
                registerSvg(object.contentDocument);
            } else {
                object.addEventListener("load", () => registerSvg(object.contentDocument));
            }
        };
        attach(elements.svg);
        attach(elements.zoomSvg);
    }

    function init() {
        loadLocalState();
        setActivePanel("materials");
        updateStepIndicators();
        renderPresets();
        render();
        initEvents();
        initialiseSvgObservers();
        loadMaterials().then(() => render());
        updateLensSwatches();
        initPresetsSvg();
    }

    init();
</script>

<style>
    input[type='range']::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        height: 16px;
        width: 16px;
        border-radius: 9999px;
        background-color: #d1b17a;
        border: none;
        box-shadow: 0 0 0 2px #20252b;
        cursor: pointer;
    }

    input[type='range']::-moz-range-thumb {
        height: 16px;
        width: 16px;
        border-radius: 9999px;
        background-color: #d1b17a;
        border: none;
        box-shadow: 0 0 0 2px #20252b;
        cursor: pointer;
    }

    dialog::backdrop {
        background: rgba(9, 10, 12, 0.75);
    }
</style>
</Layout>
