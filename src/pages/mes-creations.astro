---
import Layout from '../layouts/Layout.astro';
import { handleAuthFromCookies } from '../utils/auth.js';

export const prerender = false;

const { pb, authCookie } = await handleAuthFromCookies(Astro.request);

if (authCookie) {
	Astro.response.headers.set('Set-Cookie', authCookie);
}

if (!pb.authStore?.isValid || !pb.authStore.model?.id) {
	const redirectUrl = `/login?redirect=${encodeURIComponent(Astro.url.pathname)}`;
	return Astro.redirect(redirectUrl);
}

const userId = pb.authStore.model.id;

const LENS_LABELS: Record<string, string> = {
	transparent: 'transparent',
	gris: 'gris fonc&eacute;',
	brun: 'brun chaud',
	bleu: 'bleu miroir',
	vert: 'vert polaris&eacute;',
	rose: 'rose teint&eacute;'
};

const FINISH_LABELS: Record<string, string> = {
	brillant: 'brillant',
	mat: 'mat',
	satine: 'satin'
};

const normaliseLabel = (value: any, fallback = 'Ind&eacute;fini') => {
	if (!value) return fallback;
	return String(value).trim();
};

const serializeSvg = (value: string) => value.replace(/>\s+</g, '><');

const escapeFilterValue = (value: string) => value.replace(/"/g, '\\"');

const compositions = await pb
	.collection('Compose')
	.getFullList({
		filter: `IdUsers="${escapeFilterValue(userId)}"`,
		sort: '-created',
		fields: 'id,IdLunette,created'
	})
	.catch(() => []);

const lunetteIds = Array.from(
	new Set(
		compositions
			.map((record: any) => (Array.isArray(record?.IdLunette) ? record.IdLunette[0] : record?.IdLunette))
			.filter(Boolean)
	)
);

const fetchLunettes = async (ids: string[]) => {
	if (!ids.length) return [];
	const chunkSize = 15;
	const results: any[] = [];
	for (let i = 0; i < ids.length; i += chunkSize) {
		const chunk = ids.slice(i, i + chunkSize);
		const filterChunk = chunk.map((id) => `id="${escapeFilterValue(id)}"`).join(' || ');
		const filter = chunk.length > 1 ? `(${filterChunk})` : filterChunk;
		const records = await pb
			.collection('lunette')
			.getFullList({
				filter,
				expand: 'Materiaux_monture,Materiaux_branche'
			})
			.catch(() => []);
		results.push(...records);
	}
	return results;
};

const lunettes = await fetchLunettes(lunetteIds);
const lunetteMap = new Map<string, any>(lunettes.map((item: any) => [item.id, item]));

const materiaux = await pb
	.collection('Materiaux')
	.getFullList({ fields: 'id,libelle' })
	.catch(() => []);
const materiauxMap = new Map<string, string>(materiaux.map((item: any) => [item.id, item.libelle]));

const commandes = await pb
	.collection('Commande')
	.getFullList({
		filter: `IdUtilisateur="${escapeFilterValue(userId)}"`,
		fields: 'IdLunette'
	})
	.catch(() => []);

const orderedIds = new Set<string>(commandes.map((order: any) => order?.IdLunette).filter(Boolean));

const escapeUserHtml = (input: string) =>
	input
		.replace(/&/g, '&amp;')
		.replace(/</g, '&lt;')
		.replace(/>/g, '&gt;')
		.replace(/"/g, '&quot;')
		.replace(/'/g, '&#39;');

const creations = compositions
	.map((record: any, index: number) => {
		const relationValue = Array.isArray(record?.IdLunette) ? record.IdLunette[0] : record?.IdLunette;
		const lunette = relationValue ? lunetteMap.get(relationValue) : null;
		if (!lunette) return null;

		const frameMaterial =
			lunette?.expand?.Materiaux_monture?.libelle ??
			(lunette?.Materiaux_monture ? materiauxMap.get(lunette.Materiaux_monture) ?? null : null);
		const templeMaterial =
			lunette?.expand?.Materiaux_branche?.libelle ??
			(lunette?.Materiaux_branche ? materiauxMap.get(lunette.Materiaux_branche) ?? null : null);
		const createdAt = lunette?.created ? new Date(lunette.created) : null;
		const formattedDate = createdAt
			? createdAt.toLocaleDateString('fr-FR', {
					day: '2-digit',
					month: '2-digit',
					year: 'numeric'
			  })
			: '';

		const baseName = `Cr&eacute;ation ${index + 1}`;

		return {
			id: lunette.id,
			name: baseName,
			isOrdered: orderedIds.has(lunette.id),
			price: lunette.prix_final ?? 0,
			bridge: lunette.largeur_pont ?? 0,
			lensSize: lunette.taille_verre ?? 0,
			lensColor: normaliseLabel(LENS_LABELS[lunette.couleur_verre] ?? lunette.couleur_verre),
			lensColorKey: lunette.couleur_verre ?? '',
			finish: normaliseLabel(FINISH_LABELS[lunette.finition] ?? lunette.finition),
			finishKey: lunette.finition ?? '',
			engraving: normaliseLabel(lunette.gravure ?? ''),
			engravingPosition: lunette.position_gravure ?? '',
			materialFrame: normaliseLabel(frameMaterial, 'Mat&eacute;riau inconnu'),
			materialTemples: normaliseLabel(templeMaterial, 'Mat&eacute;riau inconnu'),
			materialFrameId: lunette.Materiaux_monture ?? null,
			materialTemplesId: lunette.Materiaux_branche ?? null,
			createdLabel: formattedDate,
			createdTimestamp: createdAt ? createdAt.getTime() : 0,
			composeId: record.id,
			svg: lunette.code_svg ? serializeSvg(lunette.code_svg) : '',
			svgUrl: lunette.code_svg
				? `data:image/svg+xml;utf8,${encodeURIComponent(serializeSvg(lunette.code_svg))}`
				: '',
			rawCreatedAt: record?.created ?? lunette?.created ?? null
		};
	})
	.filter(Boolean);

const savedCount = creations.filter((item: any) => !item.isOrdered).length;
const orderedCount = creations.length - savedCount;

const materialFilters = Array.from(
	new Set(
		creations
			.flatMap((item: any) => [item.materialFrame, item.materialTemples])
			.filter(
				(value) => value && value !== 'Mat&eacute;riau inconnu'
			)
	)
);

const infoBanner = `Vos cr&eacute;ations refl&egrave;tent votre style unique. Vous avez ${savedCount} paire${
	savedCount > 1 ? 's' : ''
} sauvegard&eacute;${savedCount > 1 ? 'es' : 'e'}.`;

const jsonSafe = JSON.stringify(creations).replace(/</g, '\\u003c');

const buildCardHtml = (item: any) => {
	const badges: string[] = [];
	if (item.materialFrame) badges.push(item.materialFrame);
	if (item.materialTemples) badges.push(item.materialTemples);
	if (item.engraving && item.engraving !== 'Ind&eacute;fini') badges.push('Grav&eacute;');

	const badgeMarkup = badges
		.map(
			(label) =>
				`<span class="inline-flex items-center rounded-full border border-[#4B4232] bg-[#262018] px-2 py-0.5 text-[10px] uppercase tracking-[0.28em] text-[#D8C8A6]">${label}</span>`
		)
		.join('');

	const preview =
		item.svgUrl && item.svgUrl.length
			? `<div class="relative h-40 w-full overflow-hidden rounded-2xl border border-[#2B3036] bg-[#1A1C20]">
					<div class="absolute inset-0 flex items-center justify-center bg-[#2B2F36]">
						<img src="${item.svgUrl}" alt="Aper&ccedil;u ${item.name}" class="w-[88%] max-w-xs translate-y-20" />
					</div>
				</div>`
			: `<div class="flex h-40 w-full items-center justify-center rounded-2xl border border-dashed border-[#2B3036] bg-[#16181D] text-xs text-[#4F5964]">
					Aper&ccedil;u indisponible
				</div>`;

	const statusLabel = item.isOrdered
		? '<span class="text-xs uppercase tracking-[0.3em] text-[#6CB17D]">Command&eacute;e</span>'
		: '<span class="text-xs uppercase tracking-[0.3em] text-[#D1B17A]">Sauvegard&eacute;e</span>';

	const engravingLine =
		item.engraving && item.engraving !== 'Ind&eacute;fini'
			? `<li>Gravure&nbsp;: &laquo;&nbsp;${escapeUserHtml(item.engraving)}&nbsp;&raquo;</li>`
			: '';

	const createdLine = item.createdLabel
		? `<li class="text-[#6F7882]">Cr&eacute;&eacute; le ${item.createdLabel}</li>`
		: '';

	const orderLabel = item.isOrdered ? 'D&eacute;j&agrave; command&eacute;e' : 'Commander';

	return `<article class="flex h-full flex-col gap-4 rounded-[26px] border border-[#1E2126] bg-[#131518] p-5 text-[#E4DCCB] shadow-[0_18px_45px_rgba(0,0,0,0.35)]">
		${preview}
		<div class="flex items-start justify-between">
			<div>
				<h2 class="font-playfair text-xl text-[#F3E9D7]">${item.name}</h2>
				<div class="mt-2 flex flex-wrap gap-2">${badgeMarkup}</div>
			</div>
			<div class="text-right">${statusLabel}</div>
		</div>
		<ul class="text-xs leading-6 text-[#A7B0BB]">
			<li>Pont&nbsp;: ${item.bridge}/10 &bull; Taille&nbsp;: ${item.lensSize}/10</li>
			<li>Verres&nbsp;: ${item.lensColor}</li>
			<li>Finition&nbsp;: <span class="text-[#D1B17A]">${item.finish}</span></li>
			${engravingLine}
			${createdLine}
		</ul>
		<div class="mt-auto flex flex-col gap-3">
			<div class="flex items-center justify-between text-sm text-[#E8D9BA]">
				<span class="text-lg font-semibold text-[#D1B17A]">${item.price.toFixed(0)}&euro;</span>
				<div class="flex items-center gap-2 text-xs uppercase tracking-[0.32em] text-[#67707B]">
					<span>${item.isOrdered ? 'Pay&eacute;e' : 'Brouillon'}</span>
				</div>
			</div>
			<div class="flex gap-2">
				<a
					href="/configurateur?edit=${encodeURIComponent(item.id)}"
					class="inline-flex flex-1 items-center justify-center gap-2 rounded-full border border-[#2B3036] bg-[#16191D] px-4 py-2 text-xs font-semibold text-[#E8DED0] transition hover:border-[#D1B17A]">
					<svg viewBox="0 0 20 20" fill="none" class="h-4 w-4" stroke="currentColor" stroke-width="1.6">
						<path stroke-linecap="round" stroke-linejoin="round" d="M4.167 15.833h11.666M11.667 4.167l4.166 4.166-8.333 8.334H3.333V11.5l8.334-7.333Z" />
					</svg>
					Modifier
				</a>
				<button
					type="button"
					class="ia-button inline-flex items-center justify-center rounded-full border border-[#2B3036] bg-[#16191D] px-4 py-2 text-xs font-semibold text-[#9EA7B1] transition hover:border-[#D1B17A]">
					<svg viewBox="0 0 20 20" fill="none" class="h-4 w-4" stroke="currentColor" stroke-width="1.6">
						<path stroke-linecap="round" stroke-linejoin="round" d="M10 3.333 11.96 7.3l4.373.351-3.33 2.8.994 4.217L10 12.92l-3.997 1.748.994-4.217-3.33-2.8 4.373-.35L10 3.333Z" />
					</svg>
					IA
				</button>
			</div>
			<button
				type="button"
				class="order-button inline-flex items-center justify-center gap-2 rounded-full bg-[#D1B17A] px-5 py-2 text-sm font-semibold text-[#2F2719] transition hover:bg-[#C39F63]"
				data-id="${item.id}"
				${item.isOrdered ? 'disabled' : ''}>
				<svg viewBox="0 0 20 20" fill="none" class="h-4 w-4" stroke="currentColor" stroke-width="1.6">
					<path stroke-linecap="round" stroke-linejoin="round" d="M4.167 5.833h11.666l-.834 8.334H5l-.833-8.334Z" />
					<path stroke-linecap="round" stroke-linejoin="round" d="M7.5 5.833V4.167A2.5 2.5 0 0 1 10 1.667a2.5 2.5 0 0 1 2.5 2.5v1.666" />
				</svg>
				${orderLabel}
			</button>
		</div>
	</article>`;
};

const initialMarkup = creations.map((item: any) => buildCardHtml(item)).join('');
const hasCreations = creations.length > 0;
---

<Layout title="Mes cr&eacute;ations | TaVue">
	<main class="bg-[#0C0D0F] py-16 text-[#EAE5DA] md:py-20">
		<div class="mx-auto w-full max-w-6xl px-4 sm:px-6 lg:px-8">
			<header class="mb-10">
				<p class="text-sm uppercase tracking-[0.35em] text-[#7B828C]">
					R&eacute;pertoire
				</p>
				<h1 class="font-playfair text-4xl font-semibold text-[#F7F2E9] md:text-5xl">
					Mes cr&eacute;ations
				</h1>
				<p class="mt-3 max-w-2xl text-sm text-[#9BA3AD]">
					Retrouvez toutes vos paires personnalis&eacute;es.
				</p>
			</header>

			<section class="mb-6 flex flex-wrap items-center gap-3 text-sm text-[#D1B17A]">
				<div class="inline-flex items-center gap-2 rounded-full border border-[#1E2126] bg-[#15171B] px-4 py-2 text-xs uppercase tracking-[0.32em] text-[#B38A4F]">
					<svg viewBox="0 0 20 20" fill="none" class="h-4 w-4" stroke="currentColor" stroke-width="1.6">
						<path stroke-linecap="round" stroke-linejoin="round" d="M3.5 4.5h13M3.5 10h13M3.5 15.5h13" />
					</svg>
					Filtres
				</div>
				<div class="flex flex-wrap gap-3">
					<select
						id="sort-select"
						class="rounded-full border border-[#2A2F35] bg-[#14171B] px-4 py-2 text-xs uppercase tracking-[0.2em] text-[#E6E0D4] focus:border-[#D1B17A] focus:outline-none"
					>
						<option value="recent">Plus r&eacute;cent</option>
						<option value="oldest">Plus ancien</option>
						<option value="priceHigh">Prix d&eacute;croissant</option>
						<option value="priceLow">Prix croissant</option>
					</select>
					<select
						id="material-select"
						class="rounded-full border border-[#2A2F35] bg-[#14171B] px-4 py-2 text-xs uppercase tracking-[0.2em] text-[#E6E0D4] focus:border-[#D1B17A] focus:outline-none"
					>
						<option value="all">Tous les mat&eacute;riaux</option>
						{materialFilters.map((item) => (
							<option value={item}>{item}</option>
						))}
					</select>
				</div>
				<div class="ml-auto flex gap-2">
					<button
						type="button"
						data-filter="all"
						class="status-filter rounded-full border border-[#272C31] bg-[#16191D] px-4 py-2 text-xs uppercase tracking-[0.28em] text-[#E6E0D4] transition hover:border-[#D1B17A]"
					>
						Toutes
					</button>
					<button
						type="button"
						data-filter="saved"
						class="status-filter rounded-full border border-[#272C31] bg-[#16191D] px-4 py-2 text-xs uppercase tracking-[0.28em] text-[#E6E0D4]/60 transition hover:border-[#D1B17A]"
					>
						Sauvegard&eacute;es
					</button>
					<button
						type="button"
						data-filter="ordered"
						class="status-filter rounded-full border border-[#272C31] bg-[#16191D] px-4 py-2 text-xs uppercase tracking-[0.28em] text-[#E6E0D4]/60 transition hover:border-[#D1B17A]"
					>
						Command&eacute;es
					</button>
				</div>
			</section>

			<div class="mb-10 rounded-3xl border border-[#3A3226] bg-gradient-to-r from-[#1B1A18] to-[#2B2620] px-6 py-5 text-sm text-[#DCC9A6] shadow-[0_20px_55px_rgba(0,0,0,0.35)]">
				<div class="flex items-start gap-3">
					<span class="mt-0.5 inline-flex h-5 w-5 items-center justify-center rounded-full bg-[#D1B17A]/20 text-[#D1B17A]">
						&#9733;
					</span>
					<p set:html={infoBanner}></p>
				</div>
			</div>

			<section>
				<div
					id="creations-grid"
					class="grid gap-6 lg:grid-cols-3"
					set:html={initialMarkup}
				></div>
				<div
					id="empty-state"
					class={`rounded-3xl border border-dashed border-[#2A2F35] bg-[#111317] px-6 py-16 text-center text-sm text-[#8C97A2] ${hasCreations ? 'hidden' : ''}`}
				>
					<p>
						Aucune cr&eacute;ation ne correspond &agrave; vos filtres.
					</p>
				</div>
			</section>

			<div class="mt-12 flex justify-center">
				<a
					href="/configurateur"
					class="inline-flex items-center gap-2 rounded-full bg-[#E6D2B1] px-6 py-3 text-sm font-medium text-[#2D261B] transition hover:bg-[#DCC29C]"
				>
					<svg viewBox="0 0 20 20" fill="none" class="h-4 w-4" stroke="currentColor" stroke-width="1.6">
						<path stroke-linecap="round" stroke-linejoin="round" d="M10 4.167v11.666M4.167 10h11.666" />
					</svg>
					Cr&eacute;er une nouvelle paire
				</a>
			</div>
		</div>
	</main>

	<script type="application/json" id="creations-data">
		{jsonSafe}
	</script>

	<script type="module">
		const dataScript = document.getElementById('creations-data');
		const creations = dataScript ? JSON.parse(dataScript.textContent || '[]') : [];
		const grid = document.getElementById('creations-grid');
		const empty = document.getElementById('empty-state');
		const sortSelect = document.getElementById('sort-select');
		const materialSelect = document.getElementById('material-select');
		const statusButtons = Array.from(document.querySelectorAll('.status-filter'));

		let statusFilter = 'all';

		const FINISH_BADGES = {
			brillant: { label: 'Brillant', tone: 'text-[#D1B17A]' },
			mat: { label: 'Mat', tone: 'text-[#D1B17A]' },
			satine: { label: 'Satin', tone: 'text-[#D1B17A]' }
		};

		const lensPreviewBackground = 'bg-[#2B2F36]';

		const escapeUser = (value) =>
			String(value)
				.replace(/&/g, '&amp;')
				.replace(/</g, '&lt;')
				.replace(/>/g, '&gt;')
				.replace(/"/g, '&quot;')
				.replace(/'/g, '&#39;');

		const formatBadge = (value) =>
			`<span class="inline-flex items-center rounded-full border border-[#4B4232] bg-[#262018] px-2 py-0.5 text-[10px] uppercase tracking-[0.28em] text-[#D8C8A6]">${value}</span>`;

		const buildCard = (item) => {
			const badges = [];
			if (item.materialFrame) badges.push(formatBadge(item.materialFrame));
			if (item.materialTemples) badges.push(formatBadge(item.materialTemples));
			if (item.engraving && item.engraving !== 'Ind&eacute;fini') {
				badges.push(formatBadge('Grav&eacute;'));
			}

			const finishTone = FINISH_BADGES[item.finishKey] ?? FINISH_BADGES[item.finish] ?? null;

			const previewSvg = item.svgUrl
				? `<div class="relative h-40 w-full overflow-hidden rounded-2xl border border-[#2B3036] bg-[#1A1C20]">
						<div class="absolute inset-0 flex items-center justify-center ${lensPreviewBackground}">
							<img src="${item.svgUrl}" alt="Aper&ccedil;u ${item.name}" class="w-[88%] max-w-xs translate-y-2" />
						</div>
					</div>`
				: `<div class="flex h-40 w-full items-center justify-center rounded-2xl border border-dashed border-[#2B3036] bg-[#16181D] text-xs text-[#4F5964]">
						Aper&ccedil;u indisponible
					</div>`;

			const statusLabel = item.isOrdered
				? '<span class="text-xs uppercase tracking-[0.3em] text-[#6CB17D]">Command&eacute;e</span>'
				: '<span class="text-xs uppercase tracking-[0.3em] text-[#D1B17A]">Sauvegard&eacute;e</span>';

			return `<article class="flex h-full flex-col gap-4 rounded-[26px] border border-[#1E2126] bg-[#131518] p-5 text-[#E4DCCB] shadow-[0_18px_45px_rgba(0,0,0,0.35)]">
				${previewSvg}
				<div class="flex items-start justify-between">
					<div>
						<h2 class="font-playfair text-xl text-[#F3E9D7]">${item.name}</h2>
						<div class="mt-2 flex flex-wrap gap-2">${badges.join('')}</div>
					</div>
					<div class="text-right">${statusLabel}</div>
				</div>
				<ul class="text-xs leading-6 text-[#A7B0BB]">
					<li>Pont&nbsp;: ${item.bridge}/10 &bull; Taille&nbsp;: ${item.lensSize}/10</li>
					<li>Verres&nbsp;: ${item.lensColor}</li>
					<li>Finition&nbsp;: <span class="${finishTone ? finishTone.tone : 'text-[#D1B17A]'}">${item.finish}</span></li>
					${
						item.engraving && item.engraving !== 'Ind&eacute;fini'
							? `<li>Gravure&nbsp;: &laquo;&nbsp;${escapeUser(item.engraving)}&nbsp;&raquo;</li>`
							: ''
					}
					${item.createdLabel ? `<li class="text-[#6F7882]">Cr&eacute;&eacute; le ${item.createdLabel}</li>` : ''}
				</ul>
				<div class="mt-auto flex flex-col gap-3">
					<div class="flex items-center justify-between text-sm text-[#E8D9BA]">
						<span class="text-lg font-semibold text-[#D1B17A]">${item.price.toFixed(0)}&euro;</span>
						<div class="flex items-center gap-2 text-xs uppercase tracking-[0.32em] text-[#67707B]">
							<span>${item.isOrdered ? 'Pay&eacute;e' : 'Brouillon'}</span>
						</div>
					</div>
					<div class="flex gap-2">
						<a
							href="/configurateur?edit=${encodeURIComponent(item.id)}"
							class="inline-flex flex-1 items-center justify-center gap-2 rounded-full border border-[#2B3036] bg-[#16191D] px-4 py-2 text-xs font-semibold text-[#E8DED0] transition hover:border-[#D1B17A]"
						>
							<svg viewBox="0 0 20 20" fill="none" class="h-4 w-4" stroke="currentColor" stroke-width="1.6">
								<path stroke-linecap="round" stroke-linejoin="round" d="M4.167 15.833h11.666M11.667 4.167l4.166 4.166-8.333 8.334H3.333V11.5l8.334-7.333Z" />
							</svg>
							Modifier
						</a>
						<button
							type="button"
							class="ia-button inline-flex items-center justify-center rounded-full border border-[#2B3036] bg-[#16191D] px-4 py-2 text-xs font-semibold text-[#9EA7B1] transition hover:border-[#D1B17A]"
						>
							<svg viewBox="0 0 20 20" fill="none" class="h-4 w-4" stroke="currentColor" stroke-width="1.6">
								<path stroke-linecap="round" stroke-linejoin="round" d="M10 3.333 11.96 7.3l4.373.351-3.33 2.8.994 4.217L10 12.92l-3.997 1.748.994-4.217-3.33-2.8 4.373-.35L10 3.333Z" />
							</svg>
							IA
						</button>
					</div>
					<button
						type="button"
						class="order-button inline-flex items-center justify-center gap-2 rounded-full bg-[#D1B17A] px-5 py-2 text-sm font-semibold text-[#2F2719] transition hover:bg-[#C39F63]"
						data-id="${item.id}"
						${item.isOrdered ? 'disabled' : ''}
					>
						<svg viewBox="0 0 20 20" fill="none" class="h-4 w-4" stroke="currentColor" stroke-width="1.6">
							<path stroke-linecap="round" stroke-linejoin="round" d="M4.167 5.833h11.666l-.834 8.334H5l-.833-8.334Z" />
							<path stroke-linecap="round" stroke-linejoin="round" d="M7.5 5.833V4.167A2.5 2.5 0 0 1 10 1.667a2.5 2.5 0 0 1 2.5 2.5v1.666" />
						</svg>
						${item.isOrdered ? 'D&eacute;j&agrave; command&eacute;e' : 'Commander'}
					</button>
				</div>
			</article>`;
		};

		const filteredData = () => {
			const material = materialSelect ? materialSelect.value : 'all';
			const sort = sortSelect ? sortSelect.value : 'recent';

			let items = creations.slice();

			if (statusFilter === 'saved') {
				items = items.filter((item) => !item.isOrdered);
			} else if (statusFilter === 'ordered') {
				items = items.filter((item) => item.isOrdered);
			}

			if (material && material !== 'all') {
				const norm = material.toLowerCase();
				items = items.filter(
					(item) =>
						item.materialFrame.toLowerCase() === norm || item.materialTemples.toLowerCase() === norm
				);
			}

			items.sort((a, b) => {
				if (sort === 'recent') return b.createdTimestamp - a.createdTimestamp;
				if (sort === 'oldest') return a.createdTimestamp - b.createdTimestamp;
				if (sort === 'priceHigh') return b.price - a.price;
				if (sort === 'priceLow') return a.price - b.price;
				return 0;
			});

			return items;
		};

		const render = () => {
			const entries = filteredData();
			if (entries.length === 0) {
				grid.innerHTML = '';
				empty.classList.remove('hidden');
				return;
			}

			empty.classList.add('hidden');
			grid.innerHTML = entries.map(buildCard).join('');

			grid.querySelectorAll('.order-button').forEach((button) => {
				button.addEventListener('click', async () => {
					if (button.disabled) return;
					const id = button.getAttribute('data-id');
					const entry = creations.find((item) => item.id === id);
					if (!entry) return;

					button.disabled = true;
					button.innerHTML = 'En cours...';

					try {
						const response = await fetch('/api/order-existing', {
							method: 'POST',
							headers: { 'Content-Type': 'application/json' },
							body: JSON.stringify({ lunetteId: entry.id })
						});

						const payload = await response.json();
						if (!response.ok && payload?.error !== 'already-ordered') {
							throw new Error(payload?.error || 'Impossible de cr&eacute;er la commande');
						}

						if (!payload?.ok && payload?.error === 'already-ordered') {
							entry.isOrdered = true;
							render();
							alert('Cette cr&eacute;ation est d&eacute;j&agrave; command&eacute;e.');
							return;
						}

						entry.isOrdered = true;
						render();
						alert('Commande cr&eacute;&eacute;e avec succ&egrave;s.');
					} catch (error) {
						console.error(error);
						alert(error?.message || 'Erreur lors de la commande.');
						entry.isOrdered = false;
						render();
					}
				});
			});
		};

		if (sortSelect) {
			sortSelect.addEventListener('change', render);
		}

		if (materialSelect) {
			materialSelect.addEventListener('change', render);
		}

		statusButtons.forEach((btn) => {
			btn.addEventListener('click', () => {
				statusButtons.forEach((other) =>
					other.classList.toggle('text-[#E6E0D4]', other === btn)
				);
				statusButtons.forEach((other) =>
					other.classList.toggle('text-[#E6E0D4]/60', other !== btn)
				);
				statusFilter = btn.dataset.filter || 'all';
				render();
			});
		});

		if (!creations.length) {
			grid.innerHTML = '';
			empty.classList.remove('hidden');
			return;
		}

		render();
	</script>
</Layout>
