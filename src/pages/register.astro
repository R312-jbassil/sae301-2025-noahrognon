---
import Layout from '../layouts/Layout.astro';
import loginImageUrl from '../assets/loginimage.png';
---

<Layout
	title="Cr&eacute;er un compte | TaVue"
	showHeader={false}
	showFooter={false}
	bodyClass="bg-[#111315]"
	mainClass="min-h-screen flex items-center justify-center px-4 py-16 md:px-10"
>
	<section class="relative w-full max-w-5xl">
		<div class="grid gap-12 md:grid-cols-[minmax(0,1fr)_minmax(0,1fr)] md:items-center">
			<article class="relative overflow-hidden rounded-[2rem] border border-[#1D1F21] bg-[#15181C] shadow-[0_35px_70px_rgba(0,0,0,0.45)]">
				<img src={loginImageUrl.src} alt="Atelier TaVue" class="h-full w-full object-cover" />
				<div class="absolute inset-0 bg-gradient-to-t from-black/75 via-black/40 to-transparent"></div>
				<div class="absolute inset-x-0 bottom-0 p-8 pb-10 md:p-10">
					<h1
						class="mb-4 font-playfair text-3xl font-semibold text-white drop-shadow md:text-4xl"
						set:html={'Rejoignez l&rsquo;atelier TaVue'}
					></h1>
					<p class="max-w-xs text-sm text-[#E5D8C2]" set:html={'Acc&eacute;dez &agrave; vos cr&eacute;ations, commandes et avantages premium.'}></p>
				</div>
			</article>

			<article class="rounded-[2rem] border border-[#262A30] bg-[#1D2025] p-8 text-[#EDE7DA] shadow-[0_28px_60px_rgba(0,0,0,0.35)] md:p-10">
				<header class="mb-8">
					<h2 class="font-playfair text-3xl text-white md:text-[2.1rem]" set:html={'Cr&eacute;er un compte'}></h2>
					<p class="mt-2 text-sm text-[#9AA2AC]" set:html={'Rejoignez la communaut&eacute; TaVue en quelques secondes'}></p>
				</header>

				<form id="register-form" class="space-y-6" novalidate>
					<div class="grid gap-6 md:grid-cols-2">
						<div class="space-y-2">
							<label for="name" class="text-xs font-semibold uppercase tracking-[0.28em] text-[#D6B785]">Nom complet</label>
							<input
								id="name"
								name="name"
								type="text"
								required
								placeholder="Votre nom et pr&eacute;nom"
								class="h-11 w-full rounded-2xl border border-[#343941] bg-[#15181C] px-4 text-sm text-[#F7F3E8] placeholder:text-[#777E88] focus:border-[#D1B17A] focus:outline-none"
							/>
						</div>
						<div class="space-y-2">
							<label for="telephone" class="text-xs font-semibold uppercase tracking-[0.28em] text-[#D6B785]">T&eacute;l&eacute;phone</label>
							<input
								id="telephone"
								name="telephone"
								type="tel"
								placeholder="+33 6 12 34 56 78"
								class="h-11 w-full rounded-2xl border border-[#343941] bg-[#15181C] px-4 text-sm text-[#F7F3E8] placeholder:text-[#777E88] focus:border-[#D1B17A] focus:outline-none"
							/>
						</div>
					</div>

					<div class="space-y-2">
						<label for="email" class="text-xs font-semibold uppercase tracking-[0.28em] text-[#D6B785]">Email</label>
						<input
							id="email"
							name="email"
							type="email"
							required
							autocomplete="email"
							placeholder="votre@email.fr"
							class="h-11 w-full rounded-2xl border border-[#343941] bg-[#15181C] px-4 text-sm text-[#F7F3E8] placeholder:text-[#777E88] focus:border-[#D1B17A] focus:outline-none"
						/>
					</div>

					<div class="grid gap-6 md:grid-cols-2">
						<div class="space-y-2">
							<label for="password" class="text-xs font-semibold uppercase tracking-[0.28em] text-[#D6B785]">Mot de passe</label>
							<input
								id="password"
								name="password"
								type="password"
								required
								minlength="8"
								placeholder="Cr&eacute;ez un mot de passe"
								class="h-11 w-full rounded-2xl border border-[#343941] bg-[#15181C] px-4 text-sm text-[#F7F3E8] placeholder:text-[#777E88] focus:border-[#D1B17A] focus:outline-none"
							/>
						</div>
						<div class="space-y-2">
							<label for="passwordConfirm" class="text-xs font-semibold uppercase tracking-[0.28em] text-[#D6B785]">Confirmation</label>
							<input
								id="passwordConfirm"
								name="passwordConfirm"
								type="password"
								required
								minlength="8"
								placeholder="Confirmez le mot de passe"
								class="h-11 w-full rounded-2xl border border-[#343941] bg-[#15181C] px-4 text-sm text-[#F7F3E8] placeholder:text-[#777E88] focus:border-[#D1B17A] focus:outline-none"
							/>
						</div>
					</div>

					<button
						type="submit"
						class="w-full rounded-2xl bg-[#D1B17A] px-6 py-3 text-sm font-semibold text-[#2F2414] shadow-[0_15px_35px_rgba(209,177,122,0.35)] transition hover:-translate-y-0.5 hover:bg-[#DBBF90] focus-visible:outline focus-visible:outline-2 focus-visible:outline-[#F4D8A5]"
					>
						Cr&eacute;er mon compte
					</button>
				</form>

				<div class="mt-8 space-y-4 text-sm text-[#8C939E]">
					<p>
						D&eacute;j&agrave; membre ?
						<a href="/login" class="font-semibold text-[#D1B17A] underline-offset-2 hover:underline" set:html={'Se connecter'}></a>
					</p>
					<div class="flex items-center gap-3 rounded-2xl border border-[#2C3037] bg-[#14171C] px-4 py-3 text-xs text-[#727A84]">
						<span aria-hidden="true" class="text-[#D1B17A]">
							<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" class="h-5 w-5">
								<path stroke-linecap="round" stroke-linejoin="round" d="M6 10.6V7.4A3.4 3.4 0 0 1 9.4 4h5.2A3.4 3.4 0 0 1 18 7.4v3.2" />
								<rect x="4" y="10.6" width="16" height="9.4" rx="2.3" />
								<path stroke-linecap="round" d="M9.5 14.3h5" />
							</svg>
						</span>
						<p set:html={'Vos donn&eacute;es sont s&eacute;curis&eacute;es et chiffr&eacute;es avec PocketBase.'}></p>
					</div>
					<p id="register-feedback" class="hidden text-sm font-medium text-[#F28B82]"></p>
				</div>
			</article>
		</div>
	</section>
</Layout>

<script type="module">
	const form = document.querySelector('#register-form');
	const feedback = document.querySelector('#register-feedback');
	const submitButton = form?.querySelector('button[type="submit"]');

	const redirectTarget =
		new URLSearchParams(window.location.search).get('redirect') ?? '/mon-compte';
	const urlError = new URLSearchParams(window.location.search).get('error');

	function showFeedback(message, type = 'error') {
		if (!feedback) return;
		feedback.textContent = message;
		feedback.classList.remove('hidden', 'text-[#F28B82]', 'text-[#81C995]');
		if (type === 'success') {
			feedback.classList.add('text-[#81C995]');
		} else {
			feedback.classList.add('text-[#F28B82]');
		}
	}

	function clearFeedback() {
		if (!feedback) return;
		feedback.textContent = '';
		feedback.classList.add('hidden');
	}

	function setLoading(button, isLoading) {
		if (!button) return;
		button.disabled = isLoading;
		button.classList.toggle('opacity-70', isLoading);
		button.classList.toggle('cursor-not-allowed', isLoading);
		button.setAttribute('aria-busy', isLoading ? 'true' : 'false');
	}

	if (urlError) {
		showFeedback(urlError);
	}

	if (form && submitButton) {
		form.addEventListener('submit', async (event) => {
			event.preventDefault();
			clearFeedback();

			const formData = new FormData(form);
			const payload = Object.fromEntries(formData.entries());

			if (!payload.email || !payload.password || !payload.passwordConfirm || !payload.name) {
				showFeedback('Merci de remplir tous les champs requis.');
				return;
			}

			if (payload.password !== payload.passwordConfirm) {
				showFeedback('Les mots de passe ne correspondent pas.');
				return;
			}

			setLoading(submitButton, true);

			try {
				const endpoint = new URL('/besoin/auth/register', window.location.origin);
				endpoint.searchParams.set('redirect', redirectTarget);

				const response = await fetch(endpoint, {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					credentials: 'include',
					body: JSON.stringify(payload)
				});

				if (response.redirected) {
					window.location.href = response.url;
					return;
				}

				if (response.status === 303) {
					const locationHeader = response.headers.get('Location') ?? redirectTarget;
					window.location.href = locationHeader;
					return;
				}

				const contentType = response.headers.get('Content-Type') ?? '';
				const data = contentType.includes('application/json') ? await response.json() : null;

				if (!response.ok) {
					const message = data?.error ?? 'Impossible de creer le compte.';
					throw new Error(message);
				}

				if (data?.redirect) {
					window.location.href = data.redirect;
					return;
				}

				window.location.href = redirectTarget;
			} catch (error) {
				showFeedback(error?.message ?? 'Une erreur est survenue.');
			} finally {
				setLoading(submitButton, false);
			}
		});
	}

</script>



