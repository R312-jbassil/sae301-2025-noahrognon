---
import Layout from "../layouts/Layout.astro";
import loginImageUrl from "../assets/loginimage.png";
---

<Layout
	title="Connexion | TaVue"
	showHeader={false}
	showFooter={false}
	bodyClass="bg-[#111315]"
	mainClass="min-h-screen flex items-center justify-center px-4 py-16 md:px-10"
>
	<section class="relative w-full max-w-5xl">
		<div
			class="grid gap-12 md:grid-cols-[minmax(0,1fr)_minmax(0,1fr)] md:items-center"
		>
			<article
				class="relative overflow-hidden rounded-[2rem] border border-[#1D1F21] bg-[#15181C] shadow-[0_35px_70px_rgba(0,0,0,0.45)]"
			>
				<img
					src={loginImageUrl.src}
					alt="Atelier de lunetterie"
					class="h-full w-full object-cover"
				/>
				<div
					class="absolute inset-0 bg-gradient-to-t from-black/75 via-black/40 to-transparent"
				>
				</div>
				<div class="absolute inset-x-0 bottom-0 p-8 pb-10 md:p-10">
					<h1
						class="mb-4 font-playfair text-3xl font-semibold text-white drop-shadow md:text-4xl"
						set:html={"L&rsquo;artisanat fran&ccedil;ais au service de votre style"}
					/>
					<p
						class="max-w-xs text-sm text-[#E5D8C2]"
						set:html={"Rejoignez une communaut&eacute; de cr&eacute;ateurs passionn&eacute;s"}
					/>
				</div>
			</article>

			<article
				class="rounded-[2rem] border border-[#262A30] bg-[#1D2025] p-8 text-[#EDE7DA] shadow-[0_28px_60px_rgba(0,0,0,0.35)] md:p-10"
			>
				<header class="mb-8">
					<h2
						class="font-playfair text-3xl text-white md:text-[2.1rem]"
					>
						Bienvenue
					</h2>
					<p
						class="mt-2 text-sm text-[#9AA2AC]"
						set:html={"Connectez-vous &agrave; votre espace"}
					/>
				</header>

				<form id="login-form" class="space-y-6" novalidate>
					<div class="space-y-2">
						<label
							for="email"
							class="text-xs font-semibold uppercase tracking-[0.28em] text-[#D6B785]"
							>Email</label
						>
						<div
							class="flex items-center gap-2 rounded-2xl border border-[#343941] bg-[#15181C] px-4 py-3 text-[#D6C7A8] transition focus-within:border-[#D1B17A] focus-within:text-[#F5E9D6]"
						>
							<span aria-hidden="true" class="text-[#D1B17A]">
								<svg
									viewBox="0 0 24 24"
									fill="none"
									stroke="currentColor"
									stroke-width="1.6"
									class="h-5 w-5"
								>
									<path
										stroke-linecap="round"
										stroke-linejoin="round"
										d="M3.5 6.75A1.75 1.75 0 0 1 5.25 5h13.5A1.75 1.75 0 0 1 20.5 6.75v10.5A1.75 1.75 0 0 1 18.75 19H5.25A1.75 1.75 0 0 1 3.5 17.25z"
									></path>
									<path
										stroke-linecap="round"
										stroke-linejoin="round"
										d="M4 7l8 6 8-6"></path>
								</svg>
							</span>
							<input
								id="email"
								name="email"
								type="email"
								required
								autocomplete="email"
								placeholder="votre@email.fr"
								class="h-8 w-full bg-transparent text-sm text-[#F7F3E8] placeholder:text-[#777E88] focus:outline-none"
							/>
						</div>
					</div>

					<div class="space-y-2">
						<label
							for="password"
							class="text-xs font-semibold uppercase tracking-[0.28em] text-[#D6B785]"
							>Mot de passe</label
						>
						<div
							class="group flex items-center gap-2 rounded-2xl border border-[#343941] bg-[#15181C] px-4 py-3 text-[#D6C7A8] transition focus-within:border-[#D1B17A] focus-within:text-[#F5E9D6]"
						>
							<span aria-hidden="true" class="text-[#D1B17A]">
								<svg
									viewBox="0 0 24 24"
									fill="none"
									stroke="currentColor"
									stroke-width="1.6"
									class="h-5 w-5"
								>
									<rect
										x="5"
										y="11"
										width="14"
										height="9"
										rx="2.2"></rect>
									<path
										stroke-linecap="round"
										d="M8 11V8.5a4 4 0 1 1 8 0V11"></path>
								</svg>
							</span>
							<input
								id="password"
								name="password"
								type="password"
								required
								autocomplete="current-password"
								placeholder="Votre mot de passe"
								class="h-8 w-full bg-transparent text-sm text-[#F7F3E8] placeholder:text-[#777E88] focus:outline-none"
							/>
							<button
								type="button"
								id="toggle-password"
								class="ml-2 inline-flex h-8 w-8 items-center justify-center rounded-full text-[#888F99] transition hover:text-[#E9D9C0]"
								aria-label="Afficher le mot de passe"
							>
								<svg
									viewBox="0 0 24 24"
									fill="none"
									stroke="currentColor"
									stroke-width="1.6"
									class="h-5 w-5"
								>
									<path
										stroke-linecap="round"
										stroke-linejoin="round"
										d="M2.5 12s3.2-6 9.5-6 9.5 6 9.5 6-3.2 6-9.5 6-9.5-6-9.5-6z"
									></path>
									<circle cx="12" cy="12" r="3.25"></circle>
								</svg>
							</button>
						</div>
					</div>

					<div class="space-y-4">
						<button
							type="submit"
							class="w-full rounded-2xl bg-[#D1B17A] px-6 py-3 text-sm font-semibold text-[#2F2414] shadow-[0_15px_35px_rgba(209,177,122,0.35)] transition hover:-translate-y-0.5 hover:bg-[#DBBF90] focus-visible:outline focus-visible:outline-2 focus-visible:outline-[#F4D8A5]"
						>
							Se connecter
						</button>

						<div
							class="flex items-center gap-4 text-xs text-[#5B626B]"
						>
							<div class="h-px flex-1 bg-[#2D3238]"></div>
							<span>ou</span>
							<div class="h-px flex-1 bg-[#2D3238]"></div>
						</div>

						<button
							type="button"
							id="google-auth"
							class="flex w-full items-center justify-center gap-2 rounded-2xl border border-[#3A4048] bg-[#15181C] px-6 py-3 text-sm font-semibold text-[#EDE7DA] transition hover:-translate-y-0.5 hover:border-[#D1B17A]"
						>
							<span aria-hidden="true">
								<svg
									viewBox="0 0 24 24"
									class="h-5 w-5"
									fill="currentColor"
								>
									<path
										d="M21.6 12.227c0-.682-.061-1.364-.185-2.027H12v3.843h5.381a4.6 4.6 0 0 1-1.987 3.018v2.503h3.214c1.885-1.735 2.983-4.293 2.983-7.337z"
									></path>
									<path
										d="M12 22c2.7 0 4.968-.89 6.624-2.436l-3.214-2.503c-.895.606-2.041.953-3.41.953-2.62 0-4.842-1.77-5.638-4.155H3.01v2.603C4.703 19.983 8.097 22 12 22z"
									></path>
									<path
										d="M6.362 13.859A5.668 5.668 0 0 1 5.97 12c0-.646.11-1.276.391-1.859V7.538H3.008A10.026 10.026 0 0 0 2 12c0 1.608.371 3.124 1.008 4.462l3.354-2.603z"
									></path>
									<path
										d="M12 6.084c1.472 0 2.785.507 3.823 1.494l2.864-2.864C16.968 2.988 14.7 2 12 2 8.097 2 4.703 4.017 3.008 7.538l3.35 2.603C7.158 7.854 9.38 6.084 12 6.084z"
									></path>
								</svg>
							</span>
							Se connecter avec Google
						</button>
					</div>
				</form>

				<div class="mt-8 space-y-4 text-sm text-[#8C939E]">
					<p>
						Pas encore de compte ?
						<a
							href="/register"
							class="font-semibold text-[#D1B17A] underline-offset-2 hover:underline"
							set:html={"Cr&eacute;er un compte"}
						/>
					</p>
					<div
						class="flex items-center gap-3 rounded-2xl border border-[#2C3037] bg-[#14171C] px-4 py-3 text-xs text-[#727A84]"
					>
						<span aria-hidden="true" class="text-[#D1B17A]">
							<svg
								viewBox="0 0 24 24"
								fill="none"
								stroke="currentColor"
								stroke-width="1.8"
								class="h-5 w-5"
							>
								<path
									stroke-linecap="round"
									stroke-linejoin="round"
									d="M6 10.6V7.4A3.4 3.4 0 0 1 9.4 4h5.2A3.4 3.4 0 0 1 18 7.4v3.2"
								></path>
								<rect
									x="4"
									y="10.6"
									width="16"
									height="9.4"
									rx="2.3"></rect>
								<path stroke-linecap="round" d="M9.5 14.3h5"
								></path>
							</svg>
						</span>
						<p
							set:html={"Vos donn&eacute;es sont s&eacute;curis&eacute;es et chiffr&eacute;es avec PocketBase."}
						/>
					</div>
					<p
						id="login-feedback"
						class="hidden text-sm font-medium text-[#F28B82]"
					>
					</p>
				</div>
			</article>
		</div>
	</section>
</Layout>

<script type="module">
	const form = document.querySelector('#login-form');
	const feedback = document.querySelector('#login-feedback');
	const submitButton = form?.querySelector('button[type="submit"]');
	const passwordInput = document.querySelector('#password');
	const togglePasswordButton = document.querySelector('#toggle-password');
	const googleButton = document.querySelector('#google-auth');

	const redirectTarget =
		new URLSearchParams(window.location.search).get('redirect') ?? '/mon-compte';
	const urlError = new URLSearchParams(window.location.search).get('error');

	function showFeedback(message, type = 'error') {
		if (!feedback) return;
		feedback.textContent = message;
		feedback.classList.remove('hidden', 'text-[#F28B82]', 'text-[#81C995]');
		if (type === 'success') {
			feedback.classList.add('text-[#81C995]');
		} else {
			feedback.classList.add('text-[#F28B82]');
		}
	}

	function clearFeedback() {
		if (!feedback) return;
		feedback.textContent = '';
		feedback.classList.add('hidden');
	}

	function setLoading(button, isLoading) {
		if (!button) return;
		button.disabled = isLoading;
		button.classList.toggle('opacity-70', isLoading);
		button.classList.toggle('cursor-not-allowed', isLoading);
		button.setAttribute('aria-busy', isLoading ? 'true' : 'false');
	}

	if (urlError) {
		showFeedback(urlError);
	}

	if (togglePasswordButton && passwordInput) {
		togglePasswordButton.addEventListener('click', () => {
			const isText = passwordInput.type === 'text';
			passwordInput.type = isText ? 'password' : 'text';
			togglePasswordButton.setAttribute(
				'aria-label',
				isText ? 'Afficher le mot de passe' : 'Masquer le mot de passe'
			);
		});
	}

	if (form && submitButton) {
		form.addEventListener('submit', async (event) => {
			event.preventDefault();
			clearFeedback();

			const formData = new FormData(form);
			const email = (formData.get('email') ?? '').toString().trim();
			const password = (formData.get('password') ?? '').toString();

			if (!email || !password) {
				showFeedback('Veuillez renseigner votre email et votre mot de passe.');
				return;
			}

			setLoading(submitButton, true);

			try {
				const response = await fetch('/besoin/auth/login', {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({ email, password })
				});

				const data = await response.json();

				if (!response.ok) {
					throw new Error(data?.error ?? 'Identifiants invalides.');
				}

				showFeedback('Connexion reussie. Redirection...', 'success');
				setTimeout(() => {
					window.location.href = redirectTarget;
				}, 600);
			} catch (error) {
				const message =
					error?.message ?? 'Echec de la connexion. Veuillez verifier vos identifiants.';
				showFeedback(message);
			} finally {
				setLoading(submitButton, false);
			}
		});
	}

	if (googleButton) {
		googleButton.addEventListener('click', () => {
			clearFeedback();
			setLoading(googleButton, true);
			const startUrl = `/besoin/auth/oauth/google/start?redirect=${encodeURIComponent(redirectTarget)}`;
			window.location.href = startUrl;
		});
	}
</script>
